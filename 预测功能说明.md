# 台风智能预测功能说明文档

## 一、功能概述

台风智能预测功能基于 **LSTM + Attention** 深度学习模型，提供台风路径和强度的智能预测服务。系统支持多种台风编号格式，具备降级策略和完整的API接口。

**新增功能**（2026-02-08）：

- **任意起点预测** - 从指定时间和位置开始预测
- **滚动预测** - 持续更新预测结果，评估预测稳定性
- **虚拟观测点预测** - 基于假设情景进行预测

---

## 二、台风编号格式

### 支持的格式

| 格式    | 示例     | 说明                  |
| ------- | -------- | --------------------- |
| 4位格式 | `2601`   | 年份后2位 + 编号2位   |
| 6位格式 | `202601` | 完整年份4位 + 编号2位 |

### 格式转换规则

- **4位 → 6位**: `2601` → `202601`
  - 根据当前年份自动判断世纪
  - 如当前是2026年，26 → 2026
  - 如当前是2025年，99 → 1999（跨世纪处理）

- **存储格式**: 统一使用6位格式存储

---

## 三、API接口说明

### 基础信息

- **基础URL**: `/api/predictions`
- **Content-Type**: `application/json`

### 1. 路径预测

**接口**: `POST /api/predictions/path`

**请求参数**:

```json
{
  "typhoon_id": "2601", // 台风编号（支持4位或6位）
  "forecast_hours": 48, // 预报时效：12/24/48/72/120
  "use_ensemble": false // 是否使用集合预测（可选）
}
```

**响应示例**:

```json
[
  {
    "id": 1,
    "typhoon_id": "202601",
    "typhoon_name": "台风名称",
    "prediction_type": "path",
    "forecast_hours": 48,
    "forecast_time": "2026-01-15T12:00:00",
    "predicted_latitude": 23.5,
    "predicted_longitude": 125.8,
    "predicted_pressure": 985.0,
    "predicted_wind_speed": 28.5,
    "prediction_model": "LSTM",
    "confidence": 0.75,
    "input_data": {
      "history_count": 12,
      "base_time": "2026-01-13T12:00:00",
      "overall_confidence": 0.73,
      "is_fallback": false,
      "original_typhoon_id": "2601"
    }
  }
]
```

### 2. 强度预测

**接口**: `POST /api/predictions/intensity`

**请求参数**:

```json
{
  "typhoon_id": "2601", // 台风编号
  "forecast_hours": 48 // 预报时效
}
```

**响应格式**: 与路径预测相同，`prediction_type` 为 `intensity`

### 3. 批量预测

**接口**: `POST /api/predictions/batch`

**请求参数**:

```json
{
  "typhoon_ids": ["2601", "2602", "2603"], // 台风编号列表
  "forecast_hours": 48
}
```

### 4. 任意起点预测 ⭐新增

**接口**: `POST /api/predictions/arbitrary-start`

**应用场景**:

- 假设情景分析（"如果台风在某时某刻位于某位置..."）
- 多机构预报对比
- 人工干预预测

**请求参数**:

```json
{
  "typhoon_id": "2601", // 台风编号
  "start_time": "2026-01-15T12:00:00", // 预测起点时间（ISO格式）
  "start_latitude": 20.5, // 起点纬度
  "start_longitude": 125.8, // 起点经度
  "start_pressure": 980.0, // 起点中心气压（可选）
  "start_wind_speed": 30.0, // 起点最大风速（可选）
  "forecast_hours": 48 // 预报时效
}
```

**响应格式**: 与路径预测相同，`prediction_type` 为 `arbitrary_start`

**使用示例**:

```bash
curl -X POST http://localhost:8000/api/predictions/arbitrary-start \
  -H "Content-Type: application/json" \
  -d '{
    "typhoon_id": "2601",
    "start_time": "2026-01-15T12:00:00",
    "start_latitude": 20.5,
    "start_longitude": 125.8,
    "start_pressure": 980,
    "start_wind_speed": 30,
    "forecast_hours": 72
  }'
```

### 5. 滚动预测 ⭐新增

**接口**: `POST /api/predictions/rolling`

**应用场景**:

- 评估预测稳定性
- 模拟实时更新场景
- 长期趋势分析

**原理**:

1. 基于当前数据进行初始预测
2. 模拟时间推移，将预测结果作为新的"观测"数据
3. 重新进行预测
4. 重复直到达到最大迭代次数或置信度低于阈值

**请求参数**:

```json
{
  "typhoon_id": "2601", // 台风编号
  "initial_forecast_hours": 48, // 初始预报时效
  "update_interval_hours": 6, // 更新间隔（小时）
  "max_iterations": 5, // 最大滚动次数
  "confidence_threshold": 0.5 // 置信度阈值
}
```

**响应格式**: `List[List[PredictionResponse]]`，每次迭代的预测结果列表

**使用示例**:

```bash
curl -X POST http://localhost:8000/api/predictions/rolling \
  -H "Content-Type: application/json" \
  -d '{
    "typhoon_id": "2601",
    "initial_forecast_hours": 48,
    "update_interval_hours": 6,
    "max_iterations": 5,
    "confidence_threshold": 0.5
  }'
```

### 6. 虚拟观测点预测 ⭐新增

**接口**: `POST /api/predictions/virtual-observations`

**应用场景**:

- 假设情景分析（"如果台风转向..."）
- 多机构预报对比
- 人工干预预测

**请求参数**:

```json
{
  "typhoon_id": "2601", // 台风编号
  "virtual_observations": [
    // 虚拟观测点列表
    {
      "timestamp": "2026-01-15T12:00:00",
      "latitude": 20.5,
      "longitude": 125.8,
      "center_pressure": 980,
      "max_wind_speed": 30
    },
    {
      "timestamp": "2026-01-15T18:00:00",
      "latitude": 21.0,
      "longitude": 126.0
    }
  ],
  "forecast_hours": 48 // 预报时效
}
```

**响应格式**: 与路径预测相同，`prediction_type` 为 `virtual_obs`

### 7. 获取预测记录

**接口**: `GET /api/predictions/{typhoon_id}`

**查询参数**:

- `prediction_type`: 筛选类型（`path`/`intensity`/`arbitrary_start`/`rolling`/`virtual_obs`）
- `limit`: 返回记录数量限制（默认100）

**示例**: `GET /api/predictions/2601?prediction_type=arbitrary_start&limit=50`

### 8. 获取预测统计

**接口**: `GET /api/predictions/stats/{typhoon_id}`

**响应示例**:

```json
{
  "typhoon_id": "2601",
  "normalized_id": "202601",
  "total_predictions": 16,
  "path_predictions": 8,
  "intensity_predictions": 8,
  "average_confidence": 0.725,
  "forecast_hour_distribution": {
    "24": 8,
    "48": 8
  },
  "latest_prediction": "2026-01-15T08:30:00"
}
```

### 9. 清除预测记录

**接口**: `DELETE /api/predictions/{typhoon_id}`

**响应示例**:

```json
{
  "typhoon_id": "2601",
  "normalized_id": "202601",
  "deleted_count": 16,
  "message": "成功删除 16 条预测记录"
}
```

---

## 四、模型架构

### LSTM + Attention 模型

```
输入层: [batch_size, seq_len=12, input_size=10]
    ↓
LSTM编码器 (3层, hidden_size=128)
    ↓
Layer Normalization
    ↓
Multi-Head Attention (8 heads)
    ↓
残差连接
    ↓
多步预测头 (8个独立预测头，对应48小时预测)
    ↓
输出层: [batch_size, pred_steps=8, output_size=4]
        (纬度, 经度, 气压, 风速)
```

### 输入特征 (10维)

| 特征             | 说明           | 归一化方式    |
| ---------------- | -------------- | ------------- |
| latitude         | 纬度           | Min-Max [0,1] |
| longitude        | 经度           | Min-Max [0,1] |
| center_pressure  | 中心气压       | Z-Score       |
| max_wind_speed   | 最大风速       | Z-Score       |
| velocity_lat     | 纬度方向速度   | 原始值        |
| velocity_lon     | 经度方向速度   | 原始值        |
| acceleration_lat | 纬度方向加速度 | 原始值        |
| acceleration_lon | 经度方向加速度 | 原始值        |
| month_sin        | 月份正弦编码   | [-1,1]        |
| month_cos        | 月份余弦编码   | [-1,1]        |

---

## 五、预测流程

### 标准预测流程

```
用户输入台风编号 (2601)
    ↓
台风ID标准化 (2601 → 202601)
    ↓
查询历史路径数据（同时匹配4位和6位格式）
    ↓
数据验证（至少3个时间点）
    ↓
数据预处理（特征工程、归一化）
    ↓
模型推理（LSTM+Attention）
    ↓
结果反归一化
    ↓
保存预测结果到数据库
    ↓
返回预测结果
```

### 任意起点预测流程

```
用户输入起点信息（时间、位置、强度）
    ↓
准备扩展的历史数据
    - 使用起点前的历史数据
    - 将起点作为序列最后一个点
    - 数据不足时向前填充
    ↓
标准预测流程
    ↓
调整预测结果的base_time为指定起点时间
    ↓
重新计算预测点的时间
    ↓
返回预测结果
```

### 滚动预测流程

```
初始历史数据
    ↓
第1次预测 → 保存结果
    ↓
模拟时间推移（如+6小时）
    ↓
将预测结果作为新的"观测"数据
    ↓
更新历史数据
    ↓
第2次预测 → 保存结果
    ↓
...（重复直到达到最大迭代次数或置信度低于阈值）
    ↓
返回所有迭代的预测结果
```

### 降级策略

当深度学习模型不可用时，自动切换到 **线性外推** 降级策略：

- 基于最近5个历史点计算平均移动趋势
- 线性外推预测未来位置
- 置信度随时间递减（0.7 → 0.3）

---

## 六、前端组件

### 组件位置

`fronted/src/components/Prediction.jsx`

### 功能特性

1. **预测类型选择**
   - 路径预测
   - 强度预测
   - 任意起点预测（新增）
   - 滚动预测（新增）

2. **预报时效选择**
   - 12小时
   - 24小时
   - 48小时（默认）
   - 72小时
   - 120小时

3. **台风编号输入**
   - 支持4位格式（如2601）
   - 支持6位格式（如202601）
   - 前端格式验证

4. **结果显示**
   - 预测概览面板
   - 详细预测数据表格
   - 置信度颜色标识
   - 强度等级自动计算

### 使用示例

```jsx
import { predictPath, predictIntensity } from "../services/api";

// 路径预测
const result = await predictPath("2601", 48);

// 强度预测
const result = await predictIntensity("2601", 48);

// 任意起点预测（需要新增API函数）
const result = await predictFromArbitraryStart({
  typhoon_id: "2601",
  start_time: "2026-01-15T12:00:00",
  start_latitude: 20.5,
  start_longitude: 125.8,
  forecast_hours: 72,
});

// 滚动预测（需要新增API函数）
const results = await rollingPrediction({
  typhoon_id: "2601",
  initial_forecast_hours: 48,
  max_iterations: 5,
});
```

---

## 七、核心代码文件

### 后端文件

| 文件路径                                                    | 说明                                   |
| ----------------------------------------------------------- | -------------------------------------- |
| `backend/app/api/prediction.py`                             | 预测API路由（含新增接口）              |
| `backend/app/services/prediction/predictor.py`              | 基础预测器主类                         |
| `backend/app/services/prediction/predictor_advanced.py`     | 高级预测器（任意起点、滚动预测）⭐新增 |
| `backend/app/services/prediction/models/lstm_model.py`      | LSTM模型定义                           |
| `backend/app/services/prediction/data/preprocessor.py`      | 数据预处理器                           |
| `backend/app/services/prediction/utils/typhoon_id_utils.py` | 台风ID格式转换工具                     |

### 前端文件

| 文件路径                                | 说明      |
| --------------------------------------- | --------- |
| `fronted/src/components/Prediction.jsx` | 预测组件  |
| `fronted/src/services/api.js`           | API服务层 |

---

## 八、错误处理

### 常见错误码

| HTTP状态码 | 错误信息               | 说明               |
| ---------- | ---------------------- | ------------------ |
| 400        | 台风编号格式无效       | ID不是4位或6位数字 |
| 400        | 历史数据不足           | 少于3个时间点      |
| 400        | 虚拟观测点格式错误     | 缺少必要字段       |
| 404        | 未找到该台风的预测记录 | 无历史预测数据     |
| 500        | 预测失败               | 模型推理错误       |

### 错误响应格式

```json
{
  "detail": "错误详细信息"
}
```

---

## 九、性能指标

### 当前模型性能

| 指标     | 数值                |
| -------- | ------------------- |
| 验证损失 | 0.004303            |
| 纬度MAE  | 0.035°（归一化后）  |
| 经度MAE  | 0.0346°（归一化后） |
| 气压MAE  | 0.12 hPa            |
| 风速MAE  | 0.21 m/s            |
| 预测时间 | < 100ms (GPU)       |

### 目标性能

| 指标         | 目标值               |
| ------------ | -------------------- |
| 验证损失     | < 0.003              |
| 纬度/经度MAE | < 0.5°（反归一化后） |
| 预测时间     | < 50ms (GPU)         |

---

## 十、使用示例

### cURL测试

```bash
# 路径预测
curl -X POST http://localhost:8000/api/predictions/path \
  -H "Content-Type: application/json" \
  -d '{
    "typhoon_id": "2601",
    "forecast_hours": 48,
    "use_ensemble": false
  }'

# 强度预测
curl -X POST http://localhost:8000/api/predictions/intensity \
  -H "Content-Type: application/json" \
  -d '{
    "typhoon_id": "202601",
    "forecast_hours": 48
  }'

# 任意起点预测
curl -X POST http://localhost:8000/api/predictions/arbitrary-start \
  -H "Content-Type: application/json" \
  -d '{
    "typhoon_id": "2601",
    "start_time": "2026-01-15T12:00:00",
    "start_latitude": 20.5,
    "start_longitude": 125.8,
    "forecast_hours": 72
  }'

# 滚动预测
curl -X POST http://localhost:8000/api/predictions/rolling \
  -H "Content-Type: application/json" \
  -d '{
    "typhoon_id": "2601",
    "initial_forecast_hours": 48,
    "update_interval_hours": 6,
    "max_iterations": 5
  }'

# 虚拟观测点预测
curl -X POST http://localhost:8000/api/predictions/virtual-observations \
  -H "Content-Type: application/json" \
  -d '{
    "typhoon_id": "2601",
    "virtual_observations": [
      {
        "timestamp": "2026-01-15T12:00:00",
        "latitude": 20.5,
        "longitude": 125.8
      }
    ],
    "forecast_hours": 48
  }'

# 获取预测记录
curl "http://localhost:8000/api/predictions/2601?limit=10"

# 获取预测统计
curl http://localhost:8000/api/predictions/stats/2601
```

### Python调用

```python
import requests

# 路径预测
response = requests.post(
    "http://localhost:8000/api/predictions/path",
    json={
        "typhoon_id": "2601",
        "forecast_hours": 48
    }
)
predictions = response.json()

# 任意起点预测
response = requests.post(
    "http://localhost:8000/api/predictions/arbitrary-start",
    json={
        "typhoon_id": "2601",
        "start_time": "2026-01-15T12:00:00",
        "start_latitude": 20.5,
        "start_longitude": 125.8,
        "forecast_hours": 72
    }
)
predictions = response.json()

# 滚动预测
response = requests.post(
    "http://localhost:8000/api/predictions/rolling",
    json={
        "typhoon_id": "2601",
        "initial_forecast_hours": 48,
        "max_iterations": 5
    }
)
rolling_results = response.json()
```

---

## 十一、注意事项

1. **历史数据要求**
   - 标准预测：至少需要3个历史观测点
   - 任意起点预测：至少需要1个历史观测点
   - 时间跨度至少12小时

2. **台风编号格式**
   - 输入4位或6位格式均可
   - 系统自动转换为6位格式存储

3. **预报时效**
   - 支持12/24/48/72/120小时
   - 超过48小时的预测置信度会降低

4. **模型加载**
   - 首次预测时会自动加载模型
   - 模型文件路径: `backend/models/best_model.pth`

5. **滚动预测**
   - 每次迭代会生成新的预测结果
   - 当置信度低于阈值时自动停止
   - 结果会保存到数据库，可通过 `prediction_type=rolling` 查询

6. **任意起点预测**
   - 起点时间应在历史数据之后或之中
   - 如果起点在历史数据之前，将使用该时间之前的数据
   - 预测结果的 `base_time` 会设置为指定的起点时间

---

## 十二、更新日志

### v1.1 (2026-02-08)

- ✅ 新增任意起点预测功能
- ✅ 新增滚动预测功能
- ✅ 新增虚拟观测点预测功能
- ✅ 优化台风ID格式处理（支持4位和6位格式）
- ✅ 新增高级预测器类 `AdvancedTyphoonPredictor`

### v1.0 (2026-02-08)

- ✅ 基础路径预测功能
- ✅ 强度预测功能
- ✅ 批量预测功能
- ✅ LSTM + Attention 模型
- ✅ 降级策略（线性外推）

---

**文档版本**: 1.1  
**更新日期**: 2026-02-08
