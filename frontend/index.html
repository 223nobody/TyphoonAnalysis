<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å°é£è·¯å¾„å¯è§†åŒ–ç³»ç»Ÿ - Typhoon Analysis System</title>

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
          "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
        background: #f5f7fa;
        overflow: hidden;
      }

      /* é¡¶éƒ¨å¯¼èˆªæ  */
      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header h1 {
        font-size: 1.8em;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .header-links {
        display: flex;
        gap: 15px;
      }

      .header-links a {
        color: white;
        text-decoration: none;
        padding: 8px 15px;
        border-radius: 5px;
        background: rgba(255, 255, 255, 0.2);
        transition: background 0.3s;
      }

      .header-links a:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      /* æ ‡ç­¾é¡µå¯¼èˆª */
      .tabs {
        background: white;
        padding: 10px 20px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        display: flex;
        gap: 5px;
      }

      .tab {
        padding: 10px 20px;
        background: transparent;
        border: none;
        cursor: pointer;
        font-size: 15px;
        color: #666;
        border-bottom: 3px solid transparent;
        transition: all 0.3s;
      }

      .tab:hover {
        color: #667eea;
        background: #f5f7fa;
      }

      .tab.active {
        color: #667eea;
        border-bottom-color: #667eea;
        font-weight: 600;
      }

      /* ä¸»å®¹å™¨ */
      .main-container {
        display: flex;
        height: calc(100vh - 120px);
        position: relative;
      }

      /* å·¦ä¾§å°é£åˆ—è¡¨é¢æ¿ */
      .sidebar {
        width: 320px;
        background: white;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .sidebar-header {
        padding: 15px;
        border-bottom: 1px solid #e5e7eb;
      }

      .sidebar-header h3 {
        margin-bottom: 15px;
        color: #333;
      }

      /* ç­›é€‰å™¨ */
      .filters {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .filter-group label {
        font-size: 13px;
        color: #666;
        font-weight: 500;
      }

      .filter-group select,
      .filter-group input {
        padding: 8px 10px;
        border: 1px solid #d1d5db;
        border-radius: 5px;
        font-size: 14px;
        outline: none;
        transition: border-color 0.3s;
      }

      .filter-group select:focus,
      .filter-group input:focus {
        border-color: #667eea;
      }

      .status-filter {
        display: flex;
        gap: 10px;
      }

      .status-btn {
        flex: 1;
        padding: 6px 10px;
        border: 1px solid #d1d5db;
        background: white;
        border-radius: 5px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.3s;
      }

      .status-btn:hover {
        border-color: #667eea;
      }

      .status-btn.active {
        background: #667eea;
        color: white;
        border-color: #667eea;
      }

      /* å¤šé€‰æ¨¡å¼å¼€å…³ */
      .multi-select-toggle {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px;
        background: #f9fafb;
        border-radius: 5px;
        margin-top: 10px;
      }

      .multi-select-toggle input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
      }

      .multi-select-toggle label {
        cursor: pointer;
        font-size: 14px;
        color: #333;
      }

      /* å°é£åˆ—è¡¨ */
      .typhoon-list {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
      }

      .typhoon-item {
        padding: 12px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.3s;
        background: white;
      }

      .typhoon-item:hover {
        border-color: #667eea;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        transform: translateX(3px);
      }

      .typhoon-item.selected {
        border-color: #667eea;
        background: #f0f4ff;
      }

      .typhoon-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 5px;
      }

      .typhoon-name-cn {
        font-size: 16px;
        font-weight: 600;
        color: #333;
      }

      .typhoon-status {
        width: 10px;
        height: 10px;
        border-radius: 50%;
      }

      .typhoon-status.active {
        background: #10b981;
        box-shadow: 0 0 8px rgba(16, 185, 129, 0.5);
      }

      .typhoon-status.inactive {
        background: #9ca3af;
      }

      .typhoon-name-en {
        font-size: 13px;
        color: #9ca3af;
        margin-bottom: 3px;
      }

      .typhoon-id {
        font-size: 12px;
        color: #667eea;
        font-weight: 500;
      }

      /* åœ°å›¾å®¹å™¨ */
      .map-container {
        flex: 1;
        position: relative;
      }

      #map {
        width: 100%;
        height: 100%;
      }

      /* å›¾ä¾‹é¢æ¿ */
      .legend-panel {
        position: absolute;
        top: 20px;
        right: 20px;
        background: white;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        max-width: 250px;
        z-index: 1000;
      }

      .legend-panel.collapsed {
        padding: 10px;
      }

      .legend-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .legend-header h4 {
        font-size: 14px;
        color: #333;
      }

      .legend-toggle {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 18px;
        color: #666;
      }

      .legend-content {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .legend-section {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .legend-section-title {
        font-size: 12px;
        font-weight: 600;
        color: #666;
        margin-bottom: 3px;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        color: #555;
      }

      .legend-color {
        width: 20px;
        height: 3px;
        border-radius: 2px;
      }

      .legend-circle {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 0 3px rgba(0, 0, 0, 0.3);
      }

      /* æ—¶é—´è½´æ’­æ”¾å™¨ */
      .timeline-player {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        padding: 15px 20px;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        display: none;
      }

      .timeline-player.active {
        display: block;
      }

      .timeline-controls {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 10px;
      }

      .timeline-btn {
        padding: 8px 15px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.3s;
      }

      .timeline-btn:hover {
        background: #5568d3;
      }

      .timeline-btn:disabled {
        background: #d1d5db;
        cursor: not-allowed;
      }

      .timeline-speed {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .timeline-speed select {
        padding: 6px 10px;
        border: 1px solid #d1d5db;
        border-radius: 5px;
        font-size: 13px;
      }

      .timeline-slider {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .timeline-slider input[type="range"] {
        width: 100%;
        height: 6px;
        border-radius: 3px;
        outline: none;
        -webkit-appearance: none;
        background: #e5e7eb;
      }

      .timeline-slider input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #667eea;
        cursor: pointer;
      }

      .timeline-time {
        font-size: 13px;
        color: #666;
        text-align: center;
      }

      /* æ¸…é™¤æŒ‰é’® */
      .clear-btn {
        position: absolute;
        top: 20px;
        left: 340px;
        padding: 10px 20px;
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        z-index: 1000;
        transition: all 0.3s;
      }

      .clear-btn:hover {
        background: #dc2626;
        transform: translateY(-2px);
      }

      /* åŠ è½½æç¤º */
      .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 2000;
      }

      .loading-overlay.show {
        display: flex;
      }

      .loading-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #e5e7eb;
        border-top-color: #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* æ»šåŠ¨æ¡æ ·å¼ */
      .typhoon-list::-webkit-scrollbar {
        width: 6px;
      }

      .typhoon-list::-webkit-scrollbar-track {
        background: #f1f1f1;
      }

      .typhoon-list::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 3px;
      }

      .typhoon-list::-webkit-scrollbar-thumb:hover {
        background: #9ca3af;
      }

      /* å…¶ä»–æ ‡ç­¾é¡µå†…å®¹ */
      .tab-content {
        display: none;
        padding: 20px;
        background: white;
        height: calc(100vh - 125px);
        overflow-y: auto;
      }

      .tab-content.active {
        display: block;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #333;
      }

      .form-group input,
      .form-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid #d1d5db;
        border-radius: 5px;
        font-size: 14px;
      }

      .btn {
        padding: 10px 20px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        margin-right: 10px;
        margin-bottom: 10px;
        transition: background 0.3s;
      }

      .btn:hover {
        background: #5568d3;
      }

      .btn-info {
        background: #3b82f6;
      }

      .btn-info:hover {
        background: #2563eb;
      }

      .result-box {
        margin-top: 20px;
        padding: 15px;
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 5px;
        max-height: 400px;
        overflow-y: auto;
      }

      .result-box pre {
        white-space: pre-wrap;
        word-wrap: break-word;
        font-size: 13px;
        color: #333;
      }

      /* æ ¼å¼åŒ–ç»“æœæ ·å¼ */
      .formatted-result {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }

      .formatted-result h3 {
        color: #667eea;
        font-size: 18px;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e5e7eb;
      }

      .formatted-result .meta-info {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 20px;
        padding: 12px;
        background: #f9fafb;
        border-radius: 6px;
      }

      .formatted-result .meta-item {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 14px;
      }

      .formatted-result .meta-label {
        color: #6b7280;
        font-weight: 500;
      }

      .formatted-result .meta-value {
        color: #333;
        font-weight: 600;
      }

      .formatted-result .content-section {
        margin-top: 20px;
      }

      .formatted-result .content-text {
        line-height: 1.8;
        color: #374151;
        font-size: 15px;
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      .formatted-result .info-card {
        background: #f0f9ff;
        border-left: 4px solid #3b82f6;
        padding: 15px;
        margin: 15px 0;
        border-radius: 4px;
      }

      .formatted-result .info-card h4 {
        color: #1e40af;
        font-size: 16px;
        margin-bottom: 10px;
      }

      .formatted-result .info-card p {
        color: #1e3a8a;
        line-height: 1.6;
        margin: 5px 0;
      }

      .formatted-result .warning-card {
        background: #fef3c7;
        border-left: 4px solid #f59e0b;
        padding: 15px;
        margin: 15px 0;
        border-radius: 4px;
      }

      .formatted-result .warning-card h4 {
        color: #92400e;
        font-size: 16px;
        margin-bottom: 10px;
      }

      .formatted-result .data-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin: 15px 0;
      }

      .formatted-result .data-item {
        background: #f9fafb;
        padding: 12px;
        border-radius: 6px;
        border: 1px solid #e5e7eb;
      }

      .formatted-result .data-item-label {
        color: #6b7280;
        font-size: 13px;
        margin-bottom: 5px;
      }

      .formatted-result .data-item-value {
        color: #111827;
        font-size: 16px;
        font-weight: 600;
      }

      .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      /* Markdownæ ·å¼ - ç”¨äºç¾åŒ–æŠ¥å‘Šå†…å®¹ */
      .markdown-body {
        font-size: 15px;
        line-height: 0.3;
        color: #333;
      }

      .markdown-body h2 {
        font-size: 1.5em;
        font-weight: 600;
        color: #1f2937;
        border-bottom: 2px solid #e5e7eb;
      }

      .markdown-body h3 {
        font-size: 1.25em;
        font-weight: 600;
        color: #374151;
      }

      .markdown-body h4 {
        font-size: 1.1em;
        font-weight: 600;
        color: #4b5563;
      }

      .markdown-body ul,
      .markdown-body ol {
        padding-left: 28px;
      }

      .markdown-body strong {
        font-weight: 600;
        color: #1f2937;
      }

      .markdown-body code {
        background-color: #f3f4f6;
        border-radius: 3px;
        font-family: "Courier New", monospace;
        font-size: 0.9em;
      }

      .markdown-body pre {
        background-color: #f3f4f6;
        padding: 2px;
        border-radius: 12px;
        overflow-x: auto;
        margin-bottom: 2px;
      }

      .markdown-body blockquote {
        border-left: 4px solid #3b82f6;
        padding-left: 16px;
        color: #6b7280;
        font-style: italic;
      }

      .markdown-body table {
        width: 100%;
        border-collapse: collapse;
      }

      .markdown-body table th,
      .markdown-body table td {
        border: 1px solid #e5e7eb;
        padding: 2px 2px;
        text-align: left;
      }

      .markdown-body table th {
        background-color: #f9fafb;
        font-weight: 600;
      }

      .markdown-body hr {
        border: none;
        border-top: 2px solid #e5e7eb;
        margin: 3px 0;
      }
    </style>
  </head>
  <body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <div class="header">
      <h1>ğŸŒ€ å°é£è·¯å¾„å¯è§†åŒ–ç³»ç»Ÿ</h1>
      <div class="header-links">
        <a href="http://localhost:8000/docs" target="_blank">ğŸ“– APIæ–‡æ¡£</a>
        <a href="http://localhost:8000/health" target="_blank">ğŸ’š ç³»ç»ŸçŠ¶æ€</a>
      </div>
    </div>

    <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
    <div class="tabs">
      <button
        class="tab active"
        type="button"
        onclick="switchTab(event, 'visualization')"
      >
        ğŸ—ºï¸ å°é£è·¯å¾„å¯è§†åŒ–
      </button>
      <button class="tab" type="button" onclick="switchTab(event, 'typhoon')">
        ğŸŒŠ å°é£æ•°æ®æŸ¥è¯¢
      </button>
      <button
        class="tab"
        type="button"
        onclick="switchTab(event, 'prediction')"
      >
        ğŸ¯ æ™ºèƒ½é¢„æµ‹
      </button>
      <button class="tab" type="button" onclick="switchTab(event, 'analysis')">
        ğŸ–¼ï¸ å›¾åƒåˆ†æ
      </button>
      <button class="tab" type="button" onclick="switchTab(event, 'report')">
        ğŸ“Š æŠ¥å‘Šç”Ÿæˆ
      </button>
    </div>

    <!-- å°é£è·¯å¾„å¯è§†åŒ–ä¸»ç•Œé¢ -->
    <div id="visualization" class="main-container">
      <!-- å·¦ä¾§å°é£åˆ—è¡¨é¢æ¿ -->
      <div class="sidebar">
        <div class="sidebar-header">
          <h3>å°é£åˆ—è¡¨</h3>

          <!-- ç­›é€‰å™¨ -->
          <div class="filters">
            <div class="filter-group">
              <label>å¹´ä»½</label>
              <select id="filterYear" onchange="loadTyphoonList()">
                <option value="">å…¨éƒ¨å¹´ä»½</option>
              </select>
            </div>

            <div class="filter-group">
              <label>çŠ¶æ€</label>
              <div class="status-filter">
                <button
                  class="status-btn active"
                  data-status=""
                  onclick="filterByStatus(this, '')"
                >
                  å…¨éƒ¨
                </button>
                <button
                  class="status-btn"
                  data-status="1"
                  onclick="filterByStatus(this, '1')"
                >
                  æ´»è·ƒä¸­
                </button>
                <button
                  class="status-btn"
                  data-status="0"
                  onclick="filterByStatus(this, '0')"
                >
                  å·²åœæ­¢
                </button>
              </div>
            </div>

            <div class="filter-group">
              <label>é€‰æ‹©å°é£</label>
              <select id="typhoonSelect" onchange="selectTyphoonFromDropdown()">
                <option value="">-- è¯·é€‰æ‹©å°é£ --</option>
              </select>
            </div>
          </div>

          <!-- å¤šé€‰æ¨¡å¼å¼€å…³ -->
          <div class="multi-select-toggle">
            <input
              type="checkbox"
              id="multiSelectMode"
              checked
              onchange="toggleMultiSelectMode()"
            />
            <label for="multiSelectMode">å¤šå°é£å åŠ æ˜¾ç¤º</label>
          </div>
        </div>

        <!-- å°é£åˆ—è¡¨ -->
        <div class="typhoon-list" id="typhoonList">
          <div style="text-align: center; padding: 20px; color: #9ca3af">
            æ­£åœ¨åŠ è½½å°é£æ•°æ®...
          </div>
        </div>
      </div>

      <!-- åœ°å›¾å®¹å™¨ -->
      <div class="map-container">
        <div id="map"></div>

        <!-- æ¸…é™¤æ‰€æœ‰è·¯å¾„æŒ‰é’® -->
        <button
          class="clear-btn"
          onclick="clearAllPaths()"
          style="display: none"
          id="clearBtn"
        >
          ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰è·¯å¾„
        </button>

        <!-- å›¾ä¾‹é¢æ¿ -->
        <div class="legend-panel" id="legendPanel">
          <div class="legend-header">
            <h4>å›¾ä¾‹</h4>
            <button class="legend-toggle" onclick="toggleLegend()">âˆ’</button>
          </div>
          <div class="legend-content" id="legendContent">
            <div class="legend-section">
              <div class="legend-section-title">å¼ºåº¦ç­‰çº§</div>
              <div class="legend-item">
                <div class="legend-color" style="background: #3498db"></div>
                <span>çƒ­å¸¦ä½å‹ (TD)</span>
              </div>
              <div class="legend-item">
                <div class="legend-color" style="background: #2ecc71"></div>
                <span>çƒ­å¸¦é£æš´ (TS)</span>
              </div>
              <div class="legend-item">
                <div class="legend-color" style="background: #f1c40f"></div>
                <span>å¼ºçƒ­å¸¦é£æš´ (STS)</span>
              </div>
              <div class="legend-item">
                <div class="legend-color" style="background: #e67e22"></div>
                <span>å°é£ (TY)</span>
              </div>
              <div class="legend-item">
                <div class="legend-color" style="background: #e74c3c"></div>
                <span>å¼ºå°é£ (STY)</span>
              </div>
              <div class="legend-item">
                <div class="legend-color" style="background: #c0392b"></div>
                <span>è¶…å¼ºå°é£ (SuperTY)</span>
              </div>
            </div>

            <div class="legend-section">
              <div class="legend-section-title">è½¨è¿¹ç‚¹å¤§å°</div>
              <div class="legend-item">
                <div
                  class="legend-circle"
                  style="width: 8px; height: 8px; background: #667eea"
                ></div>
                <span>é£é€Ÿè¾ƒå° (~10m/s)</span>
              </div>
              <div class="legend-item">
                <div
                  class="legend-circle"
                  style="width: 14px; height: 14px; background: #667eea"
                ></div>
                <span>é£é€Ÿè¾ƒå¤§ (~50m/s)</span>
              </div>
            </div>
          </div>
        </div>

        <!-- æ—¶é—´è½´æ’­æ”¾å™¨ -->
        <div class="timeline-player" id="timelinePlayer">
          <div class="timeline-controls">
            <button class="timeline-btn" onclick="resetTimeline()">
              â®ï¸ é‡ç½®
            </button>
            <button class="timeline-btn" onclick="stepBackward()">
              âª åé€€
            </button>
            <button
              class="timeline-btn"
              id="playPauseBtn"
              onclick="togglePlayPause()"
            >
              â–¶ï¸ æ’­æ”¾
            </button>
            <button class="timeline-btn" onclick="stepForward()">
              â© å‰è¿›
            </button>

            <div class="timeline-speed">
              <label style="font-size: 13px; color: #666">é€Ÿåº¦:</label>
              <select id="playbackSpeed" onchange="changePlaybackSpeed()">
                <option value="0.5">0.5x</option>
                <option value="1" selected>1x</option>
                <option value="2">2x</option>
                <option value="5">5x</option>
              </select>
            </div>
          </div>

          <div class="timeline-slider">
            <input
              type="range"
              id="timelineSlider"
              min="0"
              max="100"
              value="0"
              oninput="seekTimeline(this.value)"
            />
            <div class="timeline-time" id="timelineTime">--</div>
          </div>
        </div>

        <!-- åŠ è½½æç¤º -->
        <div class="loading-overlay" id="loadingOverlay">
          <div class="loading-spinner"></div>
        </div>
      </div>
    </div>

    <!-- å°é£æ•°æ®æŸ¥è¯¢æ ‡ç­¾é¡µ -->
    <div id="typhoon" class="tab-content">
      <h2 style="margin-bottom: 20px">å°é£æ•°æ®æŸ¥è¯¢</h2>

      <div class="grid-2">
        <div>
          <h3>å°é£åˆ—è¡¨æŸ¥è¯¢</h3>
          <div class="form-group">
            <label>å¹´ä»½</label>
            <input
              type="number"
              id="queryYear"
              placeholder="2024"
              value="2024"
            />
          </div>
          <div class="form-group">
            <label>çŠ¶æ€</label>
            <select id="queryStatus">
              <option value="">å…¨éƒ¨</option>
              <option value="1">æ´»è·ƒ</option>
              <option value="0">å·²åœæ­¢</option>
            </select>
          </div>
          <button class="btn btn-info" onclick="queryTyphoonList()">
            ğŸ“‹ æŸ¥è¯¢åˆ—è¡¨
          </button>
        </div>

        <div>
          <h3>å°é£è¯¦æƒ…æŸ¥è¯¢</h3>
          <div class="form-group">
            <label>å°é£ID</label>
            <input type="text" id="detailTyphoonId" placeholder="ä¾‹å¦‚: 2501" />
          </div>
          <button class="btn btn-info" onclick="queryTyphoonDetail()">
            ğŸ” æŸ¥è¯¢è¯¦æƒ…
          </button>
          <button class="btn btn-info" onclick="queryTyphoonPath()">
            ğŸ—ºï¸ æŸ¥è¯¢è·¯å¾„
          </button>
        </div>
      </div>

      <div
        style="
          margin-top: 30px;
          padding-top: 20px;
          border-top: 2px solid #e5e7eb;
        "
      >
        <h3>çˆ¬è™«çŠ¶æ€ä¸æ—¥å¿—</h3>
        <p style="color: #666; margin: 10px 0">
          æŸ¥çœ‹å®šæ—¶çˆ¬å–ä»»åŠ¡çš„è¿è¡ŒçŠ¶æ€å’Œå†å²æ—¥å¿—
        </p>
        <button class="btn btn-info" onclick="getCrawlerStatus()">
          ğŸ“Š æŸ¥çœ‹æœ€è¿‘çŠ¶æ€
        </button>
        <button class="btn btn-info" onclick="getCrawlerLogs()">
          ğŸ“ æŸ¥çœ‹å®Œæ•´æ—¥å¿—
        </button>
      </div>

      <div id="typhoonResult" class="result-box" style="display: none">
        <pre id="typhoonResultText"></pre>
      </div>
    </div>

    <!-- æ™ºèƒ½é¢„æµ‹æ ‡ç­¾é¡µ -->
    <div id="prediction" class="tab-content">
      <h2 style="margin-bottom: 20px">æ™ºèƒ½é¢„æµ‹</h2>

      <div class="grid-2">
        <div>
          <h3>è·¯å¾„é¢„æµ‹</h3>
          <div class="form-group">
            <label>å°é£ID</label>
            <input type="text" id="pathTyphoonId" placeholder="ä¾‹å¦‚: 2501" />
          </div>
          <button class="btn" onclick="predictPath()">ğŸ¯ è·¯å¾„é¢„æµ‹</button>
        </div>

        <div>
          <h3>å¼ºåº¦é¢„æµ‹</h3>
          <div class="form-group">
            <label>å°é£ID</label>
            <input
              type="text"
              id="intensityTyphoonId"
              placeholder="ä¾‹å¦‚: 2501"
            />
          </div>
          <button class="btn" onclick="predictIntensity()">ğŸ“ˆ å¼ºåº¦é¢„æµ‹</button>
        </div>
      </div>

      <div id="predictionResult" class="result-box" style="display: none">
        <pre id="predictionResultText"></pre>
      </div>
    </div>

    <!-- å›¾åƒåˆ†ææ ‡ç­¾é¡µ -->
    <div id="analysis" class="tab-content">
      <h2 style="margin-bottom: 20px">å›¾åƒåˆ†æ</h2>

      <h3>å«æ˜Ÿäº‘å›¾åˆ†æ</h3>
      <div class="form-group">
        <label>å°é£ID</label>
        <input type="text" id="analysisTyphoonId" placeholder="ä¾‹å¦‚: 2501" />
      </div>
      <div class="form-group">
        <label>å›¾åƒURL</label>
        <input type="text" id="imageUrl" placeholder="è¾“å…¥å«æ˜Ÿäº‘å›¾URL" />
      </div>

      <!-- åˆ†éš”çº¿ -->
      <div
        style="
          text-align: center;
          margin: 20px 0;
          color: #9ca3af;
          font-size: 14px;
        "
      >
        <span
          style="
            display: inline-block;
            width: 40%;
            height: 1px;
            background: #e5e7eb;
            vertical-align: middle;
          "
        ></span>
        <span style="display: inline-block; padding: 0 10px">æˆ–</span>
        <span
          style="
            display: inline-block;
            width: 40%;
            height: 1px;
            background: #e5e7eb;
            vertical-align: middle;
          "
        ></span>
      </div>

      <!-- æœ¬åœ°æ–‡ä»¶ä¸Šä¼  -->
      <div class="form-group">
        <label>ä¸Šä¼ æœ¬åœ°å›¾ç‰‡</label>
        <input
          type="file"
          id="imageFile"
          accept="image/*"
          style="
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
          "
        />
        <p style="color: #6b7280; font-size: 12px; margin-top: 5px">
          æ”¯æŒ JPGã€PNGã€GIF ç­‰å¸¸è§å›¾ç‰‡æ ¼å¼ï¼Œæ–‡ä»¶å¤§å°ä¸è¶…è¿‡ 10MB
        </p>
      </div>

      <button class="btn" id="analyzeImageBtn" type="button">
        ğŸ–¼ï¸ å¼€å§‹åˆ†æ
      </button>
      <div
        id="analysisLoading"
        style="display: none; margin-top: 10px; color: #3b82f6"
      >
        â³ æ­£åœ¨åˆ†æå›¾åƒï¼Œè¯·ç¨å€™...ï¼ˆå¯èƒ½éœ€è¦10-30ç§’ï¼‰
      </div>

      <div id="analysisResult" class="result-box" style="display: none">
        <div id="analysisResultFormatted" class="formatted-result"></div>
      </div>
    </div>

    <!-- æŠ¥å‘Šç”Ÿæˆæ ‡ç­¾é¡µ -->
    <div id="report" class="tab-content">
      <h2 style="margin-bottom: 20px">æŠ¥å‘Šç”Ÿæˆ</h2>

      <div class="form-group">
        <label>å°é£ID</label>
        <input type="text" id="reportTyphoonId" placeholder="ä¾‹å¦‚: 2501" />
      </div>
      <div class="form-group">
        <label>æŠ¥å‘Šç±»å‹</label>
        <select id="reportType">
          <option value="comprehensive">ç»¼åˆåˆ†ææŠ¥å‘Š</option>
          <option value="impact">å½±å“è¯„ä¼°æŠ¥å‘Š</option>
          <option value="prediction">é¢„æµ‹æŠ¥å‘Š</option>
        </select>
      </div>
      <div class="form-group">
        <label>AIæ¨¡å‹é€‰æ‹©</label>
        <select id="aiProvider">
          <option value="glm">æ™ºè°±GLM (GLM-4.7)</option>
          <option value="qwen">é€šä¹‰åƒé—® (Qwen)</option>
          <option value="deepseek">DeepSeek</option>
        </select>
        <small style="color: #6b7280; display: block; margin-top: 5px">
          ğŸ’¡ æç¤ºï¼šé€šä¹‰åƒé—®ã€DeepSeekå’ŒGLMå‡æ”¯æŒä¸­æ–‡æŠ¥å‘Šç”Ÿæˆ
        </small>
      </div>
      <button class="btn" id="generateReportBtn" type="button">
        ğŸ“Š ç”ŸæˆæŠ¥å‘Š
      </button>
      <div
        id="reportLoading"
        style="display: none; margin-top: 10px; color: #3b82f6"
      >
        â³ æ­£åœ¨ç”ŸæˆæŠ¥å‘Šï¼Œè¯·ç¨å€™...ï¼ˆå¯èƒ½éœ€è¦30-60ç§’ï¼‰
      </div>

      <div id="reportResult" class="result-box" style="display: none">
        <div id="reportResultFormatted" class="formatted-result"></div>
      </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Leaflet ChineseTmsProviders æ’ä»¶ -->
    <script src="https://unpkg.com/leaflet.chinatmsproviders@3.0.2/src/leaflet.ChineseTmsProviders.js"></script>

    <!-- Marked.js - Markdownè§£æåº“ï¼ˆå¤šCDNæºè‡ªåŠ¨å›é€€ï¼‰ -->
    <script>
      // ========== å¤šCDNæºè‡ªåŠ¨å›é€€åŠ è½½ marked.js ==========
      (function () {
        // å®šä¹‰å¤šä¸ªCDNæºï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
        const markedCdnUrls = [
          "https://unpkg.com/marked@11.1.1/marked.min.js", // unpkgï¼ˆå›½é™…ï¼Œè¾ƒç¨³å®šï¼‰
          "https://cdn.bootcdn.net/ajax/libs/marked/11.1.1/marked.min.js", // bootcdnï¼ˆå›½å†…ï¼‰
          "https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js", // cdnjs
          "https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js", // jsdelivrï¼ˆå¤‡ç”¨ï¼‰
        ];

        let currentCdnIndex = 0;
        let loadTimeout = null;

        function loadMarkedScript(urls, index) {
          if (index >= urls.length) {
            console.error("âŒ æ‰€æœ‰CDNæºå‡åŠ è½½å¤±è´¥ï¼Œmarked.jsæ— æ³•åŠ è½½");
            console.error("å°è¯•çš„CDNæº:", urls);
            return;
          }

          const url = urls[index];
          console.log(
            `ğŸ”„ å°è¯•ä»CDNåŠ è½½ marked.js [${index + 1}/${urls.length}]: ${url}`
          );

          const script = document.createElement("script");
          script.src = url;

          // è®¾ç½®åŠ è½½è¶…æ—¶ï¼ˆ10ç§’ï¼‰
          loadTimeout = setTimeout(() => {
            console.warn(`âš ï¸ CDNæº ${index + 1} åŠ è½½è¶…æ—¶: ${url}`);
            script.remove();
            loadMarkedScript(urls, index + 1);
          }, 10000);

          script.onload = function () {
            clearTimeout(loadTimeout);
            console.log(`âœ… marked.js åŠ è½½æˆåŠŸ [CDNæº ${index + 1}]: ${url}`);
            console.log(
              "markedç‰ˆæœ¬:",
              typeof marked !== "undefined"
                ? marked.version || "æœªçŸ¥"
                : "æœªå®šä¹‰"
            );

            // æµ‹è¯•Markdownè§£æ
            if (typeof marked !== "undefined" && marked.parse) {
              try {
                const testMarkdown = "## æµ‹è¯•æ ‡é¢˜\n- åˆ—è¡¨é¡¹1\n- **åŠ ç²—æ–‡æœ¬**";
                const testHtml = marked.parse(testMarkdown);
                console.log("âœ… Markdownè§£ææµ‹è¯•æˆåŠŸ");
                console.log("æµ‹è¯•è¾“å…¥:", testMarkdown);
                console.log("æµ‹è¯•è¾“å‡º:", testHtml);
              } catch (e) {
                console.error("âŒ Markdownè§£ææµ‹è¯•å¤±è´¥:", e);
              }
            }
          };

          script.onerror = function () {
            clearTimeout(loadTimeout);
            console.warn(`âš ï¸ CDNæº ${index + 1} åŠ è½½å¤±è´¥: ${url}`);
            script.remove();
            loadMarkedScript(urls, index + 1);
          };

          document.head.appendChild(script);
        }

        // å¼€å§‹åŠ è½½
        loadMarkedScript(markedCdnUrls, 0);
      })();

      // ========== æ£€æµ‹marked.jsæ˜¯å¦åŠ è½½æˆåŠŸ ==========
      window.addEventListener("load", function () {
        if (typeof marked !== "undefined" && marked.parse) {
          console.log("âœ… marked.js æœ€ç»ˆåŠ è½½çŠ¶æ€: æˆåŠŸ");
        } else {
          console.error("âŒ marked.js æœ€ç»ˆåŠ è½½çŠ¶æ€: å¤±è´¥");
          console.log("markedå¯¹è±¡:", typeof marked);
          console.log("marked.parse:", typeof marked?.parse);
          console.warn("âš ï¸ æŠ¥å‘Šç”Ÿæˆå’Œå›¾åƒåˆ†æçš„Markdownæ¸²æŸ“åŠŸèƒ½å°†å—å½±å“");
        }
      });
    </script>

    <script>
      // ========== é¡µé¢åˆ·æ–°æ£€æµ‹ï¼ˆè¯Šæ–­ç”¨ï¼‰ ==========
      window.addEventListener("beforeunload", function (e) {
        console.log("âš ï¸âš ï¸âš ï¸ é¡µé¢å³å°†åˆ·æ–°æˆ–å…³é—­ï¼");
        console.log("è§¦å‘æ—¶é—´:", new Date().toISOString());
        console.log("è§¦å‘åŸå› : å¯èƒ½æ˜¯Live Serverçƒ­é‡è½½ã€ç”¨æˆ·åˆ·æ–°æˆ–å…³é—­é¡µé¢");
        console.trace("åˆ·æ–°è§¦å‘è°ƒç”¨æ ˆ:");
      });

      // è®°å½•é¡µé¢åŠ è½½æ—¶é—´
      console.log("ğŸ“„ é¡µé¢åŠ è½½æ—¶é—´:", new Date().toISOString());
      console.log(
        'ğŸ” å¦‚æœåœ¨æŠ¥å‘Šç”Ÿæˆåçœ‹åˆ°"é¡µé¢å³å°†åˆ·æ–°"æ—¥å¿—ï¼Œè¯´æ˜æ˜¯Live Serverçƒ­é‡è½½å¯¼è‡´çš„è·³è½¬'
      );

      const API_BASE_URL = "http://localhost:8000/api";

      // å…¨å±€å˜é‡
      let map = null;
      let allTyphoons = [];
      let filteredTyphoons = [];
      let selectedTyphoons = new Map(); // å­˜å‚¨é€‰ä¸­çš„å°é£åŠå…¶è·¯å¾„æ•°æ®
      let currentFilter = { year: "", status: "", search: "" };
      let isMultiSelectMode = true; // é»˜è®¤å¼€å¯å¤šé€‰æ¨¡å¼
      let pathLayers = new Map(); // å­˜å‚¨æ¯ä¸ªå°é£çš„å›¾å±‚

      // æ—¶é—´è½´ç›¸å…³
      let timelineData = [];
      let currentTimeIndex = 0;
      let isPlaying = false;
      let playbackInterval = null;
      let playbackSpeed = 1;

      // APIè°ƒç”¨çŠ¶æ€æ ‡å¿—ï¼ˆé˜²æ­¢é‡å¤è§¦å‘ï¼‰
      let isAnalyzing = false;
      let isGeneratingReport = false;

      // ========== å…¨å±€é”™è¯¯å¤„ç† ==========
      // æ•è·æ‰€æœ‰æœªå¤„ç†çš„Promiseå¼‚å¸¸
      window.addEventListener("unhandledrejection", function (event) {
        console.error("âŒ æœªæ•è·çš„Promiseå¼‚å¸¸:", event.reason);
        console.error("Promise:", event.promise);
        event.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼ˆé¡µé¢é‡è½½ï¼‰
        return false; // é¢å¤–ä¿é™©
      });

      // æ•è·æ‰€æœ‰JavaScriptè¿è¡Œæ—¶é”™è¯¯
      window.addEventListener("error", function (event) {
        console.error("âŒ JavaScriptè¿è¡Œæ—¶é”™è¯¯:", event.error);
        console.error("æ–‡ä»¶:", event.filename, "è¡Œå·:", event.lineno);
        event.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸º
        return false; // é¢å¤–ä¿é™©
      });

      // åˆå§‹åŒ–
      document.addEventListener("DOMContentLoaded", function () {
        console.log("ğŸš€ é¡µé¢åˆå§‹åŒ–å¼€å§‹...");

        try {
          initMap();
          initYearFilter();
          loadTyphoonList();

          // ç»‘å®šå›¾åƒåˆ†ææŒ‰é’®äº‹ä»¶
          const analyzeImageBtn = document.getElementById("analyzeImageBtn");
          if (analyzeImageBtn) {
            // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§äº‹ä»¶ç›‘å¬å™¨
            analyzeImageBtn.onclick = null;

            // ä½¿ç”¨æ•è·é˜¶æ®µï¼Œç¡®ä¿æœ€å…ˆæ‰§è¡Œ
            analyzeImageBtn.addEventListener(
              "click",
              function (event) {
                // ç«‹å³é˜»æ­¢æ‰€æœ‰é»˜è®¤è¡Œä¸ºå’Œäº‹ä»¶ä¼ æ’­
                event.preventDefault();
                event.stopPropagation();
                event.stopImmediatePropagation();

                // é˜²æ­¢é‡å¤ç‚¹å‡»
                if (isAnalyzing) {
                  console.warn("âš ï¸ å›¾åƒåˆ†ææ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·å‹¿é‡å¤ç‚¹å‡»");
                  return false;
                }

                // è°ƒç”¨åˆ†æå‡½æ•°ï¼Œæ•è·æ‰€æœ‰å¼‚å¸¸
                analyzeImage().catch((error) => {
                  console.error("âŒ å›¾åƒåˆ†æå¼‚å¸¸:", error);
                  isAnalyzing = false;
                });

                return false; // é¢å¤–ä¿é™©
              },
              true
            ); // ä½¿ç”¨æ•è·é˜¶æ®µ
          } else {
            console.error("âŒ æœªæ‰¾åˆ°å›¾åƒåˆ†ææŒ‰é’® (analyzeImageBtn)");
          }

          // ç»‘å®šæŠ¥å‘Šç”ŸæˆæŒ‰é’®äº‹ä»¶
          const generateReportBtn =
            document.getElementById("generateReportBtn");
          if (generateReportBtn) {
            // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§äº‹ä»¶ç›‘å¬å™¨
            generateReportBtn.onclick = null;

            // ä½¿ç”¨æ•è·é˜¶æ®µï¼Œç¡®ä¿æœ€å…ˆæ‰§è¡Œ
            generateReportBtn.addEventListener(
              "click",
              function (event) {
                // ç«‹å³é˜»æ­¢æ‰€æœ‰é»˜è®¤è¡Œä¸ºå’Œäº‹ä»¶ä¼ æ’­
                event.preventDefault();
                event.stopPropagation();
                event.stopImmediatePropagation();

                // é˜²æ­¢é‡å¤ç‚¹å‡»
                if (isGeneratingReport) {
                  console.warn("âš ï¸ æŠ¥å‘Šç”Ÿæˆæ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·å‹¿é‡å¤ç‚¹å‡»");
                  return false;
                }

                // è°ƒç”¨æŠ¥å‘Šç”Ÿæˆå‡½æ•°ï¼Œæ•è·æ‰€æœ‰å¼‚å¸¸
                generateReport().catch((error) => {
                  console.error("âŒ æŠ¥å‘Šç”Ÿæˆå¼‚å¸¸:", error);
                  isGeneratingReport = false;
                });

                return false; // é¢å¤–ä¿é™©
              },
              true
            ); // ä½¿ç”¨æ•è·é˜¶æ®µ
          }

          console.log("âœ… é¡µé¢åˆå§‹åŒ–å®Œæˆ");
        } catch (error) {
          console.error("âŒ åˆå§‹åŒ–å¤±è´¥:", error);
        }
      });

      // ========== åœ°å›¾åˆå§‹åŒ– ==========
      function initMap() {
        map = L.map("map", {
          center: [25, 125],
          zoom: 5,
          minZoom: 3,
          maxZoom: 18,
        });

        // å°è¯•ä½¿ç”¨é«˜å¾·åœ°å›¾ä¸­æ–‡æ ‡æ³¨åº•å›¾
        try {
          if (typeof L.tileLayer.chinaProvider !== "undefined") {
            // å¦‚æœæ’ä»¶åŠ è½½æˆåŠŸï¼Œä½¿ç”¨é«˜å¾·åœ°å›¾
            L.tileLayer
              .chinaProvider("GaoDe.Normal.Map", {
                maxZoom: 18,
                minZoom: 3,
              })
              .addTo(map);
            console.log("âœ… ä½¿ç”¨é«˜å¾·åœ°å›¾ä¸­æ–‡æ ‡æ³¨");
          } else {
            throw new Error("ChineseTmsProvidersæ’ä»¶æœªåŠ è½½");
          }
        } catch (error) {
          // å¦‚æœæ’ä»¶åŠ è½½å¤±è´¥ï¼Œå›é€€åˆ°OpenStreetMap
          console.warn(
            "âš ï¸ é«˜å¾·åœ°å›¾åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨OpenStreetMap:",
            error.message
          );
          L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: "Â© OpenStreetMap contributors",
            maxZoom: 18,
            minZoom: 3,
          }).addTo(map);
        }
      }

      // åˆå§‹åŒ–å¹´ä»½ç­›é€‰å™¨
      function initYearFilter() {
        const yearSelect = document.getElementById("filterYear");
        const currentYear = new Date().getFullYear();

        for (let year = currentYear; year >= 2005; year--) {
          const option = document.createElement("option");
          option.value = year;
          option.textContent = year + "å¹´";
          yearSelect.appendChild(option);
        }

        // è®¾ç½®é»˜è®¤é€‰ä¸­2025å¹´
        yearSelect.value = "2025";
      }

      // ========== é€šç”¨APIè°ƒç”¨ ==========
      async function callAPI(url, options = {}) {
        try {
          const response = await fetch(url, {
            ...options,
            headers: {
              "Content-Type": "application/json",
              ...options.headers,
            },
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || "è¯·æ±‚å¤±è´¥");
          }

          return await response.json();
        } catch (error) {
          console.error("âŒ APIè°ƒç”¨å¤±è´¥:", error.message);
          throw error;
        }
      }

      // ========== æ ‡ç­¾é¡µåˆ‡æ¢ ==========
      function switchTab(event, tabName) {
        // ========== æ–°å¢ï¼šè°ƒç”¨æ ˆè¿½è¸ªï¼Œå¸®åŠ©å®šä½è·³è½¬æ¥æº ==========
        console.log("ğŸ” switchTab è¢«è°ƒç”¨:", tabName);
        console.log("è°ƒç”¨æ¥æº:", event ? "ç”¨æˆ·ç‚¹å‡»" : "ç¨‹åºè°ƒç”¨");
        if (!event) {
          console.log("è°ƒç”¨æ ˆ:", new Error().stack);
        }

        // ========== æ–°å¢ï¼šé˜²æ­¢åœ¨æŠ¥å‘Šç”Ÿæˆè¿‡ç¨‹ä¸­åˆ‡æ¢æ ‡ç­¾ ==========
        if (typeof isGeneratingReport !== "undefined" && isGeneratingReport) {
          console.warn("âš ï¸ æŠ¥å‘Šç”Ÿæˆä¸­ï¼Œé˜»æ­¢æ ‡ç­¾åˆ‡æ¢");
          if (event) {
            event.preventDefault();
            event.stopPropagation();
          }
          return false;
        }

        // ========== æ–°å¢ï¼šé˜²æ­¢åœ¨å›¾åƒåˆ†æè¿‡ç¨‹ä¸­åˆ‡æ¢æ ‡ç­¾ ==========
        if (typeof isAnalyzing !== "undefined" && isAnalyzing) {
          console.warn("âš ï¸ å›¾åƒåˆ†æä¸­ï¼Œé˜»æ­¢æ ‡ç­¾åˆ‡æ¢");
          if (event) {
            event.preventDefault();
            event.stopPropagation();
          }
          return false;
        }

        // é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼ˆå…³é”®ä¿®å¤ï¼‰
        if (event) {
          event.preventDefault();
          event.stopPropagation();
        }

        try {
          console.log(`ğŸ”„ åˆ‡æ¢åˆ°æ ‡ç­¾é¡µ: ${tabName}`);

          // éšè—æ‰€æœ‰æ ‡ç­¾å†…å®¹
          document.querySelectorAll(".tab-content").forEach((content) => {
            content.classList.remove("active");
          });
          document.querySelectorAll(".main-container").forEach((container) => {
            container.style.display = "none";
          });

          // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„activeç±»
          document.querySelectorAll(".tab").forEach((tab) => {
            tab.classList.remove("active");
          });

          // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾å†…å®¹
          if (tabName === "visualization") {
            document.getElementById("visualization").style.display = "flex";
          } else {
            const targetElement = document.getElementById(tabName);
            if (targetElement) {
              targetElement.classList.add("active");
            }
          }

          // æ·»åŠ activeç±»åˆ°é€‰ä¸­çš„æ ‡ç­¾æŒ‰é’®
          if (event && event.target) {
            event.target.classList.add("active");
          } else {
            // é™çº§æ–¹æ¡ˆï¼šé€šè¿‡tabNameæŸ¥æ‰¾å¯¹åº”æŒ‰é’®
            const buttons = document.querySelectorAll(".tab");
            buttons.forEach((btn, index) => {
              const tabNames = [
                "visualization",
                "typhoon",
                "prediction",
                "analysis",
                "report",
              ];
              if (tabNames[index] === tabName) {
                btn.classList.add("active");
              }
            });
          }

          console.log(`âœ… æ ‡ç­¾é¡µåˆ‡æ¢æˆåŠŸ: ${tabName}`);
        } catch (error) {
          console.error("âŒ æ ‡ç­¾é¡µåˆ‡æ¢å¤±è´¥:", error);
        }

        return false; // é˜»æ­¢ä»»ä½•é»˜è®¤è¡Œä¸º
      }

      // ========== åŠ è½½å°é£åˆ—è¡¨ ==========
      async function loadTyphoonList() {
        const year = document.getElementById("filterYear").value;
        const status = currentFilter.status;

        try {
          let url = `${API_BASE_URL}/typhoons?limit=100`;
          if (year) url += `&year=${year}`;
          if (status !== "") url += `&status=${status}`;

          const data = await callAPI(url);
          allTyphoons = data.items || [];
          currentFilter.year = year;

          applyFilters();
        } catch (error) {
          console.error("åŠ è½½å°é£åˆ—è¡¨å¤±è´¥:", error);
          document.getElementById("typhoonList").innerHTML =
            '<div style="text-align: center; padding: 20px; color: #ef4444;">åŠ è½½å¤±è´¥: ' +
            error.message +
            "</div>";
        }
      }

      // ========== ç­›é€‰åŠŸèƒ½ ==========
      function filterByStatus(btn, status) {
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document
          .querySelectorAll(".status-btn")
          .forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");

        currentFilter.status = status;
        applyFilters();
      }

      function applyFilters() {
        filteredTyphoons = allTyphoons.filter((typhoon) => {
          // çŠ¶æ€ç­›é€‰
          if (
            currentFilter.status !== "" &&
            typhoon.status.toString() !== currentFilter.status
          ) {
            return false;
          }

          return true;
        });

        renderTyphoonList();
      }

      // ========== å°é£ä¸‹æ‹‰é€‰æ‹©æ¡† ==========
      // æ¸²æŸ“å°é£ä¸‹æ‹‰é€‰æ‹©æ¡†
      function renderTyphoonSelect() {
        const selectElement = document.getElementById("typhoonSelect");

        // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™é»˜è®¤é€‰é¡¹ï¼‰
        selectElement.innerHTML = '<option value="">-- è¯·é€‰æ‹©å°é£ --</option>';

        // æ·»åŠ å°é£é€‰é¡¹
        filteredTyphoons.forEach((typhoon) => {
          const option = document.createElement("option");
          option.value = typhoon.typhoon_id;
          const cnName = typhoon.typhoon_name_cn || "";
          const enName = typhoon.typhoon_name || "";
          option.textContent =
            `${typhoon.typhoon_id} ${cnName} ${enName}`.trim();
          selectElement.appendChild(option);
        });
      }

      // ä»ä¸‹æ‹‰æ¡†é€‰æ‹©å°é£
      function selectTyphoonFromDropdown() {
        const selectElement = document.getElementById("typhoonSelect");
        const typhoonId = selectElement.value;

        if (typhoonId) {
          selectTyphoon(typhoonId);
        }
      }

      // ========== æ¸²æŸ“å°é£åˆ—è¡¨ ==========
      function renderTyphoonList() {
        const listContainer = document.getElementById("typhoonList");

        if (filteredTyphoons.length === 0) {
          listContainer.innerHTML =
            '<div style="text-align: center; padding: 20px; color: #9ca3af;">æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„å°é£</div>';
          // åŒæ—¶æ›´æ–°ä¸‹æ‹‰é€‰æ‹©æ¡†
          renderTyphoonSelect();
          return;
        }

        listContainer.innerHTML = filteredTyphoons
          .map(
            (typhoon) => `
          <div class="typhoon-item ${
            selectedTyphoons.has(typhoon.typhoon_id) ? "selected" : ""
          }"
               onclick="selectTyphoon('${typhoon.typhoon_id}')">
            <div class="typhoon-item-header">
              <span class="typhoon-name-cn">${
                typhoon.typhoon_name_cn || typhoon.typhoon_name
              }</span>
              <div class="typhoon-status ${
                typhoon.status === 1 ? "active" : "inactive"
              }"></div>
            </div>
            <div class="typhoon-name-en">${typhoon.typhoon_name}</div>
            <div class="typhoon-id">ç¼–å·: ${typhoon.typhoon_id}</div>
          </div>
        `
          )
          .join("");

        // åŒæ—¶æ›´æ–°ä¸‹æ‹‰é€‰æ‹©æ¡†
        renderTyphoonSelect();
      }

      // ========== å¤šé€‰æ¨¡å¼åˆ‡æ¢ ==========
      function toggleMultiSelectMode() {
        isMultiSelectMode = document.getElementById("multiSelectMode").checked;

        if (!isMultiSelectMode && selectedTyphoons.size > 1) {
          // é€€å‡ºå¤šé€‰æ¨¡å¼æ—¶ï¼Œåªä¿ç•™æœ€åä¸€ä¸ªé€‰ä¸­çš„å°é£
          const lastTyphoonId = Array.from(selectedTyphoons.keys()).pop();
          clearAllPaths();
          if (lastTyphoonId) {
            selectTyphoon(lastTyphoonId);
          }
        }
      }

      // ========== é€‰æ‹©å°é£ ==========
      async function selectTyphoon(typhoonId) {
        if (!isMultiSelectMode) {
          // å•é€‰æ¨¡å¼ï¼šæ¸…é™¤ä¹‹å‰çš„é€‰æ‹©
          clearAllPaths();
        }

        // å¦‚æœå·²ç»é€‰ä¸­ï¼Œåˆ™å–æ¶ˆé€‰ä¸­
        if (selectedTyphoons.has(typhoonId)) {
          selectedTyphoons.delete(typhoonId);
          if (pathLayers.has(typhoonId)) {
            pathLayers
              .get(typhoonId)
              .forEach((layer) => map.removeLayer(layer));
            pathLayers.delete(typhoonId);
          }
          renderTyphoonList();
          updateClearButton();
          return;
        }

        // åŠ è½½å¹¶ç»˜åˆ¶å°é£è·¯å¾„
        await drawTyphoonPath(typhoonId);
        renderTyphoonList();
        updateClearButton();
      }

      // ========== ç»˜åˆ¶å°é£è·¯å¾„ ==========
      async function drawTyphoonPath(typhoonId) {
        showLoading(true);

        try {
          const data = await callAPI(
            `${API_BASE_URL}/typhoons/${typhoonId}/path?limit=5000`
          );
          const pathData = data.items || [];

          if (pathData.length === 0) {
            alert("è¯¥å°é£æš‚æ— è·¯å¾„æ•°æ®");
            showLoading(false);
            return;
          }

          // å­˜å‚¨è·¯å¾„æ•°æ®
          selectedTyphoons.set(typhoonId, pathData);

          // åˆ›å»ºå›¾å±‚æ•°ç»„
          const layers = [];

          // ç»˜åˆ¶è½¨è¿¹çº¿
          const coordinates = pathData.map((point) => [
            point.latitude,
            point.longitude,
          ]);

          // æŒ‰å¼ºåº¦åˆ†æ®µç»˜åˆ¶
          for (let i = 0; i < pathData.length - 1; i++) {
            const point = pathData[i];
            const nextPoint = pathData[i + 1];

            const color = getColorByIntensity(point.intensity);
            const weight = 3;

            const line = L.polyline(
              [
                [point.latitude, point.longitude],
                [nextPoint.latitude, nextPoint.longitude],
              ],
              {
                color: color,
                weight: weight,
                opacity: 0.8,
              }
            ).addTo(map);

            layers.push(line);
          }

          // ç»˜åˆ¶è½¨è¿¹ç‚¹
          pathData.forEach((point, index) => {
            const color = getColorByIntensity(point.intensity);
            const radius = getRadiusByWindSpeed(point.max_wind_speed);

            const circle = L.circleMarker([point.latitude, point.longitude], {
              radius: radius,
              fillColor: color,
              color: "white",
              weight: 2,
              opacity: 1,
              fillOpacity: 0.8,
            }).addTo(map);

            // æ·»åŠ å¼¹çª—
            const popupContent = createPopupContent(point);
            circle.bindPopup(popupContent);

            layers.push(circle);
          });

          // å­˜å‚¨å›¾å±‚
          pathLayers.set(typhoonId, layers);

          // åœ°å›¾è‡ªåŠ¨èšç„¦
          if (coordinates.length > 0) {
            const bounds = L.latLngBounds(coordinates);
            map.fitBounds(bounds, { padding: [50, 50] });
          }

          showLoading(false);
        } catch (error) {
          console.error("ç»˜åˆ¶å°é£è·¯å¾„å¤±è´¥:", error);
          alert("åŠ è½½è·¯å¾„æ•°æ®å¤±è´¥: " + error.message);
          showLoading(false);
        }
      }

      // ========== æ ¹æ®å¼ºåº¦è·å–é¢œè‰² ==========
      function getColorByIntensity(intensity) {
        if (!intensity) return "#95a5a6";

        const intensityMap = {
          çƒ­å¸¦ä½å‹: "#3498db",
          TD: "#3498db",
          çƒ­å¸¦é£æš´: "#2ecc71",
          TS: "#2ecc71",
          å¼ºçƒ­å¸¦é£æš´: "#f1c40f",
          STS: "#f1c40f",
          å°é£: "#e67e22",
          TY: "#e67e22",
          å¼ºå°é£: "#e74c3c",
          STY: "#e74c3c",
          è¶…å¼ºå°é£: "#c0392b",
          SuperTY: "#c0392b",
        };

        return intensityMap[intensity] || "#95a5a6";
      }

      // ========== æ ¹æ®é£é€Ÿè®¡ç®—ç‚¹çš„å¤§å° ==========
      function getRadiusByWindSpeed(windSpeed) {
        if (!windSpeed || windSpeed === 0) return 5;
        return Math.min(5 + windSpeed / 10, 15);
      }

      // ========== åˆ›å»ºå¼¹çª—å†…å®¹ ==========
      function createPopupContent(point) {
        const timestamp = new Date(point.timestamp).toLocaleString("zh-CN");

        return `
          <div style="font-size: 13px; line-height: 1.6;">
            <strong style="font-size: 14px; color: #667eea;">å°é£è·¯å¾„ç‚¹ä¿¡æ¯</strong><br/>
            <strong>æ—¶é—´ï¼š</strong>${timestamp}<br/>
            <strong>ä½ç½®ï¼š</strong>åŒ—çº¬ ${point.latitude.toFixed(
              2
            )}Â°ï¼Œä¸œç» ${point.longitude.toFixed(2)}Â°<br/>
            <strong>ä¸­å¿ƒæ°”å‹ï¼š</strong>${
              point.center_pressure
                ? point.center_pressure + " hPa"
                : "æš‚æ— æ•°æ®"
            }<br/>
            <strong>æœ€å¤§é£é€Ÿï¼š</strong>${
              point.max_wind_speed ? point.max_wind_speed + " m/s" : "æš‚æ— æ•°æ®"
            }<br/>
            <strong>ç§»åŠ¨é€Ÿåº¦ï¼š</strong>${
              point.moving_speed ? point.moving_speed + " km/h" : "æš‚æ— æ•°æ®"
            }<br/>
            <strong>ç§»åŠ¨æ–¹å‘ï¼š</strong>${
              point.moving_direction || "æš‚æ— æ•°æ®"
            }<br/>
            <strong>å¼ºåº¦ç­‰çº§ï¼š</strong>${point.intensity || "æš‚æ— æ•°æ®"}<br/>
          </div>
        `;
      }

      // ========== æ¸…é™¤æ‰€æœ‰è·¯å¾„ ==========
      function clearAllPaths() {
        selectedTyphoons.clear();
        pathLayers.forEach((layers) => {
          layers.forEach((layer) => map.removeLayer(layer));
        });
        pathLayers.clear();
        renderTyphoonList();
        updateClearButton();
        hideTimeline();
      }

      // ========== æ›´æ–°æ¸…é™¤æŒ‰é’®æ˜¾ç¤º ==========
      function updateClearButton() {
        const clearBtn = document.getElementById("clearBtn");
        if (selectedTyphoons.size > 0) {
          clearBtn.style.display = "block";
        } else {
          clearBtn.style.display = "none";
        }
      }

      // ========== å›¾ä¾‹æŠ˜å  ==========
      function toggleLegend() {
        const panel = document.getElementById("legendPanel");
        const content = document.getElementById("legendContent");
        const toggle = document.querySelector(".legend-toggle");

        if (content.style.display === "none") {
          content.style.display = "flex";
          toggle.textContent = "âˆ’";
          panel.classList.remove("collapsed");
        } else {
          content.style.display = "none";
          toggle.textContent = "+";
          panel.classList.add("collapsed");
        }
      }

      // ========== æ—¶é—´è½´åŠŸèƒ½ ==========
      function showTimeline() {
        document.getElementById("timelinePlayer").classList.add("active");
      }

      function hideTimeline() {
        document.getElementById("timelinePlayer").classList.remove("active");
        stopPlaying();
      }

      function togglePlayPause() {
        if (isPlaying) {
          pauseTimeline();
        } else {
          playTimeline();
        }
      }

      function playTimeline() {
        isPlaying = true;
        document.getElementById("playPauseBtn").textContent = "â¸ï¸ æš‚åœ";

        const interval = 1000 / playbackSpeed;
        playbackInterval = setInterval(() => {
          if (currentTimeIndex < timelineData.length - 1) {
            currentTimeIndex++;
            updateTimelineDisplay();
          } else {
            pauseTimeline();
          }
        }, interval);
      }

      function pauseTimeline() {
        isPlaying = false;
        document.getElementById("playPauseBtn").textContent = "â–¶ï¸ æ’­æ”¾";
        if (playbackInterval) {
          clearInterval(playbackInterval);
          playbackInterval = null;
        }
      }

      function stopPlaying() {
        pauseTimeline();
        currentTimeIndex = 0;
        timelineData = [];
      }

      function resetTimeline() {
        currentTimeIndex = 0;
        updateTimelineDisplay();
      }

      function stepForward() {
        if (currentTimeIndex < timelineData.length - 1) {
          currentTimeIndex++;
          updateTimelineDisplay();
        }
      }

      function stepBackward() {
        if (currentTimeIndex > 0) {
          currentTimeIndex--;
          updateTimelineDisplay();
        }
      }

      function seekTimeline(value) {
        currentTimeIndex = parseInt(value);
        updateTimelineDisplay();
      }

      function changePlaybackSpeed() {
        playbackSpeed = parseFloat(
          document.getElementById("playbackSpeed").value
        );
        if (isPlaying) {
          pauseTimeline();
          playTimeline();
        }
      }

      function updateTimelineDisplay() {
        const slider = document.getElementById("timelineSlider");
        slider.value = currentTimeIndex;

        if (timelineData[currentTimeIndex]) {
          const time = new Date(timelineData[currentTimeIndex].timestamp);
          document.getElementById("timelineTime").textContent =
            time.toLocaleString("zh-CN", {
              year: "numeric",
              month: "2-digit",
              day: "2-digit",
              hour: "2-digit",
              minute: "2-digit",
            });
        }
      }

      // ========== åŠ è½½æç¤º ==========
      function showLoading(show) {
        const overlay = document.getElementById("loadingOverlay");
        if (show) {
          overlay.classList.add("show");
        } else {
          overlay.classList.remove("show");
        }
      }

      // ========== å°é£æ•°æ®æŸ¥è¯¢åŠŸèƒ½ ==========
      async function queryTyphoonList() {
        const year = document.getElementById("queryYear").value;
        const status = document.getElementById("queryStatus").value;

        try {
          let url = `${API_BASE_URL}/typhoons?limit=100`;
          if (year) url += `&year=${year}`;
          if (status !== "") url += `&status=${status}`;

          const data = await callAPI(url);
          showResult("typhoon", data);
        } catch (error) {
          showResult("typhoon", { error: error.message }, true);
        }
      }

      async function queryTyphoonDetail() {
        const typhoonId = document.getElementById("detailTyphoonId").value;
        if (!typhoonId) {
          alert("è¯·è¾“å…¥å°é£ID");
          return;
        }

        try {
          const data = await callAPI(`${API_BASE_URL}/typhoons/${typhoonId}`);
          showResult("typhoon", data);
        } catch (error) {
          showResult("typhoon", { error: error.message }, true);
        }
      }

      async function queryTyphoonPath() {
        const typhoonId = document.getElementById("detailTyphoonId").value;
        if (!typhoonId) {
          alert("è¯·è¾“å…¥å°é£ID");
          return;
        }

        try {
          const data = await callAPI(
            `${API_BASE_URL}/typhoons/${typhoonId}/path?limit=1000`
          );
          showResult("typhoon", data);
        } catch (error) {
          showResult("typhoon", { error: error.message }, true);
        }
      }

      async function getCrawlerStatus() {
        try {
          const data = await callAPI(`${API_BASE_URL}/crawler/logs?limit=10`);
          showResult("typhoon", {
            message: "æœ€è¿‘çš„çˆ¬è™«æ—¥å¿—",
            logs: data,
          });
        } catch (error) {
          showResult("typhoon", { error: error.message }, true);
        }
      }

      async function getCrawlerLogs() {
        try {
          const data = await callAPI(`${API_BASE_URL}/crawler/logs?limit=50`);
          showResult("typhoon", {
            message: "çˆ¬è™«æ—¥å¿—åˆ—è¡¨",
            total: data.length,
            logs: data,
          });
        } catch (error) {
          showResult("typhoon", { error: error.message }, true);
        }
      }

      // ========== æ™ºèƒ½é¢„æµ‹åŠŸèƒ½ ==========
      async function predictPath() {
        const typhoonId = document.getElementById("pathTyphoonId").value;
        if (!typhoonId) {
          alert("è¯·è¾“å…¥å°é£ID");
          return;
        }

        try {
          const data = await callAPI(
            `${API_BASE_URL}/prediction/path/${typhoonId}`,
            {
              method: "POST",
            }
          );
          showResult("prediction", data);
        } catch (error) {
          showResult("prediction", { error: error.message }, true);
        }
      }

      async function predictIntensity() {
        const typhoonId = document.getElementById("intensityTyphoonId").value;
        if (!typhoonId) {
          alert("è¯·è¾“å…¥å°é£ID");
          return;
        }

        try {
          const data = await callAPI(
            `${API_BASE_URL}/prediction/intensity/${typhoonId}`,
            {
              method: "POST",
            }
          );
          showResult("prediction", data);
        } catch (error) {
          showResult("prediction", { error: error.message }, true);
        }
      }

      // ========== å›¾åƒåˆ†æåŠŸèƒ½ ==========
      async function analyzeImage() {
        // è®¾ç½®çŠ¶æ€æ ‡å¿—
        isAnalyzing = true;

        const typhoonId = document.getElementById("analysisTyphoonId").value;
        const imageUrl = document.getElementById("imageUrl").value;
        const imageFile = document.getElementById("imageFile").files[0];
        const loadingEl = document.getElementById("analysisLoading");
        const resultBox = document.getElementById("analysisResult");

        try {
          // éªŒè¯å°é£ID
          if (!typhoonId) {
            alert("è¯·è¾“å…¥å°é£ID");
            isAnalyzing = false;
            return;
          }

          // éªŒè¯æ˜¯å¦æä¾›äº†å›¾åƒURLæˆ–æœ¬åœ°æ–‡ä»¶
          if (!imageUrl && !imageFile) {
            alert("è¯·è¾“å…¥å›¾åƒURLæˆ–ä¸Šä¼ æœ¬åœ°å›¾ç‰‡");
            isAnalyzing = false;
            return;
          }

          // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
          if (loadingEl) {
            loadingEl.style.display = "block";
          }
          if (resultBox) {
            resultBox.style.display = "none";
          }

          let data;

          // ä¼˜å…ˆä½¿ç”¨æœ¬åœ°æ–‡ä»¶
          if (imageFile) {
            // éªŒè¯æ–‡ä»¶å¤§å°ï¼ˆ10MB = 10 * 1024 * 1024 bytesï¼‰
            const maxSize = 10 * 1024 * 1024;
            if (imageFile.size > maxSize) {
              alert("æ–‡ä»¶å¤§å°è¶…è¿‡10MBé™åˆ¶ï¼Œè¯·é€‰æ‹©æ›´å°çš„æ–‡ä»¶");
              if (loadingEl) loadingEl.style.display = "none";
              isAnalyzing = false;
              return;
            }

            // éªŒè¯æ–‡ä»¶ç±»å‹
            const validTypes = [
              "image/jpeg",
              "image/jpg",
              "image/png",
              "image/gif",
              "image/webp",
              "image/bmp",
            ];
            if (!validTypes.includes(imageFile.type)) {
              alert("ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼Œè¯·ä¸Šä¼  JPGã€PNGã€GIF ç­‰å¸¸è§å›¾ç‰‡æ ¼å¼");
              if (loadingEl) loadingEl.style.display = "none";
              isAnalyzing = false;
              return;
            }

            // å°†æ–‡ä»¶è½¬æ¢ä¸ºBase64
            const base64Image = await fileToBase64(imageFile);

            // ä½¿ç”¨Base64å›¾åƒè°ƒç”¨API
            data = await callAPI(`${API_BASE_URL}/analysis/satellite-image`, {
              method: "POST",
              body: JSON.stringify({
                typhoon_id: typhoonId,
                image_url: base64Image,
              }),
            });
          } else {
            // ä½¿ç”¨URLæ–¹å¼
            data = await callAPI(`${API_BASE_URL}/analysis/satellite-image`, {
              method: "POST",
              body: JSON.stringify({
                typhoon_id: typhoonId,
                image_url: imageUrl,
              }),
            });
          }

          // éšè—åŠ è½½çŠ¶æ€
          if (loadingEl) {
            loadingEl.style.display = "none";
          }

          // æ˜¾ç¤ºç»“æœ
          showResult("analysis", data);
        } catch (error) {
          console.error("âŒ å›¾åƒåˆ†æå¤±è´¥:", error.message);

          // éšè—åŠ è½½çŠ¶æ€
          if (loadingEl) {
            loadingEl.style.display = "none";
          }

          // æ˜¾ç¤ºé”™è¯¯
          showResult(
            "analysis",
            { error: error.message || "å›¾åƒåˆ†æå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•" },
            true
          );
        } finally {
          // é‡ç½®çŠ¶æ€æ ‡å¿—
          isAnalyzing = false;
        }
      }

      // ========== æ–‡ä»¶è½¬Base64å‡½æ•° ==========
      function fileToBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => {
            // è¿”å›å®Œæ•´çš„Data URLæ ¼å¼ï¼ˆåŒ…å«MIMEç±»å‹ï¼‰
            resolve(reader.result);
          };
          reader.onerror = (error) => {
            reject(error);
          };
          reader.readAsDataURL(file);
        });
      }

      // ========== æŠ¥å‘Šç”ŸæˆåŠŸèƒ½ ==========
      async function generateReport() {
        // è®¾ç½®çŠ¶æ€æ ‡å¿—
        isGeneratingReport = true;

        const typhoonId = document.getElementById("reportTyphoonId").value;
        const reportType = document.getElementById("reportType").value;
        const aiProvider = document.getElementById("aiProvider").value;
        const loadingEl = document.getElementById("reportLoading");
        const resultBox = document.getElementById("reportResult");

        try {
          // éªŒè¯è¾“å…¥
          if (!typhoonId) {
            alert("è¯·è¾“å…¥å°é£ID");
            isGeneratingReport = false;
            return;
          }

          // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
          if (loadingEl) {
            loadingEl.style.display = "block";
          }
          if (resultBox) {
            resultBox.style.display = "none";
          }

          const data = await callAPI(`${API_BASE_URL}/report/generate`, {
            method: "POST",
            body: JSON.stringify({
              typhoon_id: typhoonId,
              report_type: reportType,
              ai_provider: aiProvider,
            }),
          });

          // éšè—åŠ è½½çŠ¶æ€
          if (loadingEl) {
            loadingEl.style.display = "none";
          }

          // æ˜¾ç¤ºç»“æœ
          showResult("report", data);

          // ========== å¤šæ¬¡å¼ºåˆ¶æ¿€æ´»æŠ¥å‘Šæ ‡ç­¾é¡µï¼Œé˜²æ­¢çŠ¶æ€è¢«é‡ç½® ==========
          const lockReportTab = (attemptNumber) => {
            const reportTabBtn = document.querySelector(
              '.tab[onclick*="report"]'
            );
            if (reportTabBtn) {
              document
                .querySelectorAll(".tab")
                .forEach((tab) => tab.classList.remove("active"));
              reportTabBtn.classList.add("active");
            }

            const reportTabContent = document.getElementById("report");
            if (reportTabContent) {
              document
                .querySelectorAll(".tab-content")
                .forEach((content) => content.classList.remove("active"));
              document
                .querySelectorAll(".main-container")
                .forEach((container) => (container.style.display = "none"));
              reportTabContent.classList.add("active");
            }

            console.log(`âœ… æŠ¥å‘Šæ ‡ç­¾é¡µé”å®š [ç¬¬${attemptNumber}æ¬¡]`);
          };

          // å¤šæ¬¡é”å®šï¼Œè¦†ç›–å¯èƒ½çš„å»¶è¿Ÿè·³è½¬
          setTimeout(() => lockReportTab(1), 50);
          setTimeout(() => lockReportTab(2), 150);
          setTimeout(() => lockReportTab(3), 300);
          setTimeout(() => lockReportTab(4), 500);
          setTimeout(() => lockReportTab(5), 1000);
          console.log("âœ… æŠ¥å‘Šæ ‡ç­¾é¡µå¤šæ¬¡é”å®šå·²è®¾ç½®ï¼ˆ5æ¬¡ï¼ŒæŒç»­1ç§’ï¼‰");
        } catch (error) {
          console.error("âŒ æŠ¥å‘Šç”Ÿæˆå¤±è´¥:", error.message);

          // éšè—åŠ è½½çŠ¶æ€
          if (loadingEl) {
            loadingEl.style.display = "none";
          }

          // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
          showResult(
            "report",
            { error: error.message || "æŠ¥å‘Šç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•" },
            true
          );

          // ========== é”™è¯¯æƒ…å†µä¸‹ä¹Ÿå¤šæ¬¡å¼ºåˆ¶æ¿€æ´»æŠ¥å‘Šæ ‡ç­¾é¡µ ==========
          const lockReportTabError = (attemptNumber) => {
            const reportTabBtn = document.querySelector(
              '.tab[onclick*="report"]'
            );
            if (reportTabBtn) {
              document
                .querySelectorAll(".tab")
                .forEach((tab) => tab.classList.remove("active"));
              reportTabBtn.classList.add("active");
            }

            const reportTabContent = document.getElementById("report");
            if (reportTabContent) {
              document
                .querySelectorAll(".tab-content")
                .forEach((content) => content.classList.remove("active"));
              document
                .querySelectorAll(".main-container")
                .forEach((container) => (container.style.display = "none"));
              reportTabContent.classList.add("active");
            }

            console.log(`âœ… æŠ¥å‘Šæ ‡ç­¾é¡µé”å®šï¼ˆé”™è¯¯æƒ…å†µï¼‰[ç¬¬${attemptNumber}æ¬¡]`);
          };

          // å¤šæ¬¡é”å®šï¼Œè¦†ç›–å¯èƒ½çš„å»¶è¿Ÿè·³è½¬
          setTimeout(() => lockReportTabError(1), 50);
          setTimeout(() => lockReportTabError(2), 150);
          setTimeout(() => lockReportTabError(3), 300);
          setTimeout(() => lockReportTabError(4), 500);
          setTimeout(() => lockReportTabError(5), 1000);
          console.log("âœ… æŠ¥å‘Šæ ‡ç­¾é¡µå¤šæ¬¡é”å®šå·²è®¾ç½®ï¼ˆé”™è¯¯æƒ…å†µï¼Œ5æ¬¡ï¼ŒæŒç»­1ç§’ï¼‰");
        } finally {
          // é‡ç½®çŠ¶æ€æ ‡å¿—
          isGeneratingReport = false;
        }
      }

      // ========== JSONå­—æ®µåç¿»è¯‘å‡½æ•°ï¼ˆç”¨äºå°é£æ•°æ®æŸ¥è¯¢ï¼‰ ==========
      function translateJsonKeys(data) {
        // å­—æ®µæ˜ å°„è¡¨
        const fieldTranslations = {
          // åŸºæœ¬ä¿¡æ¯
          typhoon_id: "å°é£ç¼–å·",
          typhoon_name: "è‹±æ–‡åç§°",
          typhoon_name_cn: "ä¸­æ–‡åç§°",
          year: "å¹´ä»½",
          status: "çŠ¶æ€",
          id: "æ•°æ®åº“ID",

          // ä½ç½®ä¿¡æ¯
          latitude: "çº¬åº¦",
          longitude: "ç»åº¦",

          // æ°”è±¡æ•°æ®
          center_pressure: "ä¸­å¿ƒæ°”å‹",
          max_wind_speed: "æœ€å¤§é£é€Ÿ",
          moving_speed: "ç§»åŠ¨é€Ÿåº¦",
          moving_direction: "ç§»åŠ¨æ–¹å‘",
          intensity: "å¼ºåº¦ç­‰çº§",

          // æ—¶é—´ä¿¡æ¯
          timestamp: "æ—¶é—´æˆ³",
          created_at: "åˆ›å»ºæ—¶é—´",
          updated_at: "æ›´æ–°æ—¶é—´",

          // åˆ—è¡¨ç›¸å…³
          total: "æ€»æ•°",
          items: "æ•°æ®åˆ—è¡¨",
          logs: "æ—¥å¿—åˆ—è¡¨",
          message: "æ¶ˆæ¯",

          // çˆ¬è™«ç›¸å…³
          task_type: "ä»»åŠ¡ç±»å‹",
          error: "é”™è¯¯ä¿¡æ¯",
        };

        // å¦‚æœä¸æ˜¯å¯¹è±¡æˆ–æ•°ç»„ï¼Œç›´æ¥è¿”å›
        if (data === null || data === undefined) {
          return data;
        }

        // å¦‚æœæ˜¯æ•°ç»„ï¼Œé€’å½’å¤„ç†æ¯ä¸ªå…ƒç´ 
        if (Array.isArray(data)) {
          return data.map((item) => translateJsonKeys(item));
        }

        // å¦‚æœä¸æ˜¯å¯¹è±¡ç±»å‹ï¼Œç›´æ¥è¿”å›
        if (typeof data !== "object") {
          return data;
        }

        // ç¿»è¯‘å¯¹è±¡çš„å­—æ®µå
        const result = {};

        for (const [key, value] of Object.entries(data)) {
          // è·å–ä¸­æ–‡å­—æ®µåï¼Œå¦‚æœæ²¡æœ‰æ˜ å°„åˆ™ä¿æŒåŸå­—æ®µå
          const chineseKey = fieldTranslations[key] || key;

          // ç‰¹æ®Šå¤„ç†ï¼šçŠ¶æ€å­—æ®µå€¼è½¬æ¢
          if (key === "status" && typeof value === "number") {
            result[chineseKey] = value === 0 ? "å·²åœæ­¢" : "æ´»è·ƒä¸­";
          }
          // ç‰¹æ®Šå¤„ç†ï¼šæ·»åŠ å•ä½
          else if (key === "center_pressure" && typeof value === "number") {
            result[chineseKey] = value + " hPa";
          } else if (key === "max_wind_speed" && typeof value === "number") {
            result[chineseKey] = value + " m/s";
          } else if (key === "moving_speed" && typeof value === "number") {
            result[chineseKey] = value + " km/h";
          } else if (key === "latitude" && typeof value === "number") {
            result[chineseKey] = value + "Â°";
          } else if (key === "longitude" && typeof value === "number") {
            result[chineseKey] = value + "Â°";
          }
          // é€’å½’å¤„ç†åµŒå¥—å¯¹è±¡å’Œæ•°ç»„
          else if (typeof value === "object" && value !== null) {
            result[chineseKey] = translateJsonKeys(value);
          }
          // å…¶ä»–å­—æ®µç›´æ¥èµ‹å€¼
          else {
            result[chineseKey] = value;
          }
        }

        return result;
      }

      // ========== æ˜¾ç¤ºç»“æœ ==========
      function showResult(module, data, isError = false) {
        try {
          const resultBox = document.getElementById(`${module}Result`);
          const resultText = document.getElementById(`${module}ResultText`);
          const resultFormatted = document.getElementById(
            `${module}ResultFormatted`
          );

          // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
          if (!resultBox) {
            console.error(`âŒ æ‰¾ä¸åˆ°ç»“æœå®¹å™¨: ${module}Result`);
            return;
          }

          resultBox.style.display = "block";

          // å¤„ç†æ•°æ®ä¸ºç©ºçš„æƒ…å†µ
          if (data === null || data === undefined) {
            if (resultText) {
              resultText.textContent = isError ? "å‘ç”Ÿé”™è¯¯" : "æ— æ•°æ®";
              resultText.style.color = isError ? "#ef4444" : "#6b7280";
            }
            if (resultFormatted) {
              resultFormatted.innerHTML = isError
                ? '<p style="color: #ef4444;">å‘ç”Ÿé”™è¯¯</p>'
                : '<p style="color: #6b7280;">æ— æ•°æ®</p>';
            }
            return;
          }

          // å¦‚æœæœ‰æ ¼å¼åŒ–å®¹å™¨ï¼Œå°è¯•ç¾åŒ–æ˜¾ç¤ºï¼ˆä»…ç”¨äº report å’Œ analysis æ¨¡å—ï¼‰
          if (resultFormatted && !isError) {
            try {
              if (module === "report") {
                formatReportResult(resultFormatted, data);
              } else if (module === "analysis") {
                formatAnalysisResult(resultFormatted, data);
              } else {
                // å…¶ä»–æ¨¡å—éšè—æ ¼å¼åŒ–å®¹å™¨
                resultFormatted.innerHTML = "";
              }
            } catch (formatError) {
              console.error("âŒ ç¾åŒ–æ˜¾ç¤ºå¤±è´¥:", formatError.message);
              // ç¾åŒ–å¤±è´¥æ˜¾ç¤ºé”™è¯¯æç¤º
              if (resultFormatted) {
                resultFormatted.innerHTML = `<p style="color: #f59e0b; padding: 10px; background: #fef3c7; border-radius: 4px;">âš ï¸ æ ¼å¼åŒ–æ˜¾ç¤ºå¤±è´¥: ${formatError.message}</p>`;
              }
            }
          }

          // å¦‚æœæœ‰ resultText å…ƒç´ ï¼ˆç”¨äº typhoon ç­‰æ¨¡å—ï¼‰ï¼Œæ˜¾ç¤º JSON æ•°æ®
          if (resultText) {
            try {
              let displayData = data;

              // å¯¹äº typhoon æ¨¡å—ï¼Œç¿»è¯‘å­—æ®µåä¸ºä¸­æ–‡
              if (module === "typhoon" && !isError) {
                try {
                  displayData = translateJsonKeys(data);
                  console.log("âœ… å­—æ®µåå·²ç¿»è¯‘ä¸ºä¸­æ–‡");
                } catch (translateError) {
                  console.warn(
                    "âš ï¸ å­—æ®µç¿»è¯‘å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹æ•°æ®:",
                    translateError
                  );
                  displayData = data;
                }
              }

              const jsonString = JSON.stringify(displayData, null, 2);
              resultText.textContent = jsonString;
              resultText.style.color = isError ? "#ef4444" : "#333";
            } catch (jsonError) {
              console.error("âŒ JSONåºåˆ—åŒ–å¤±è´¥:", jsonError.message);
              resultText.textContent = "æ•°æ®æ˜¾ç¤ºå¤±è´¥";
              resultText.style.color = "#ef4444";
            }
          }
        } catch (err) {
          console.error("âŒ showResult å‡½æ•°å‡ºé”™:", err.message);

          // æœ€åçš„é™çº§æ–¹æ¡ˆï¼šæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
          try {
            const resultBox = document.getElementById(`${module}Result`);
            const resultText = document.getElementById(`${module}ResultText`);
            const resultFormatted = document.getElementById(
              `${module}ResultFormatted`
            );
            if (resultBox) {
              resultBox.style.display = "block";
              if (resultText) {
                resultText.textContent = "æ•°æ®æ˜¾ç¤ºå¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•";
                resultText.style.color = "#ef4444";
              }
              if (resultFormatted) {
                resultFormatted.innerHTML =
                  '<p style="color: #ef4444;">æ•°æ®æ˜¾ç¤ºå¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</p>';
              }
              console.log("âœ… é™çº§æ˜¾ç¤ºæˆåŠŸ");
            }
          } catch (e) {
            console.error("âŒ é™çº§æ˜¾ç¤ºä¹Ÿå¤±è´¥:", e);
          }
        }
      }

      // ========== ç¾åŒ–æŠ¥å‘Šå±•ç¤º ==========
      function formatReportResult(container, data) {
        try {
          const reportContent = data.report_content || "";
          const typhoonId = data.typhoon_id || "æœªçŸ¥";
          const typhoonName = data.typhoon_name || "æœªå‘½å";
          const modelUsed = data.model_used || "æœªçŸ¥";
          const createdAt = data.created_at || new Date().toISOString();

          // æ ¼å¼åŒ–æ—¶é—´
          const formattedTime = new Date(createdAt).toLocaleString("zh-CN", {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
          });

          let html = `
            <h3>ğŸ“Š å°é£åˆ†ææŠ¥å‘Š</h3>
            <div class="meta-info">
              <div class="meta-item">
                <span class="meta-label">ğŸ†” å°é£ç¼–å·:</span>
                <span class="meta-value">${typhoonId}</span>
              </div>
              <div class="meta-item">
                <span class="meta-label">ğŸŒ€ å°é£åç§°:</span>
                <span class="meta-value">${typhoonName || "æœªå‘½å"}</span>
              </div>
              <div class="meta-item">
                <span class="meta-label">ğŸ¤– AIæ¨¡å‹:</span>
                <span class="meta-value">${modelUsed}</span>
              </div>
              <div class="meta-item">
                <span class="meta-label">â° ç”Ÿæˆæ—¶é—´:</span>
                <span class="meta-value">${formattedTime}</span>
              </div>
            </div>
          `;

          if (reportContent) {
            console.log("ğŸ“Š [formatReportResult] å¼€å§‹å¤„ç†æŠ¥å‘Šå†…å®¹");
            console.log("åŸå§‹å†…å®¹é•¿åº¦:", reportContent.length);
            console.log("åŸå§‹å†…å®¹å‰100å­—ç¬¦:", reportContent.substring(0, 100));

            // ä½¿ç”¨marked.jså°†Markdownè½¬æ¢ä¸ºHTML
            let htmlContent = reportContent;
            const markedAvailable =
              typeof marked !== "undefined" && marked.parse;
            console.log("marked.js å¯ç”¨:", markedAvailable);

            if (markedAvailable) {
              try {
                console.log("ğŸ”„ å¼€å§‹Markdownè§£æ...");
                htmlContent = marked.parse(reportContent);
                console.log("âœ… Markdownè§£ææˆåŠŸ");
                console.log("è§£æåHTMLé•¿åº¦:", htmlContent.length);
                console.log(
                  "è§£æåHTMLå‰200å­—ç¬¦:",
                  htmlContent.substring(0, 200)
                );
              } catch (e) {
                console.error("âŒ Markdownè§£æå¤±è´¥:", e);
                console.warn("é™çº§ä½¿ç”¨åŸå§‹æ–‡æœ¬");
                // å¦‚æœMarkdownè§£æå¤±è´¥ï¼Œä½¿ç”¨åŸå§‹æ–‡æœ¬å¹¶ä¿ç•™æ¢è¡Œ
                htmlContent = reportContent.replace(/\n/g, "<br>");
              }
            } else {
              console.warn("âš ï¸ marked.jsæœªåŠ è½½ï¼Œä½¿ç”¨åŸå§‹æ–‡æœ¬");
              // å¦‚æœmarked.jsæœªåŠ è½½ï¼Œä½¿ç”¨åŸå§‹æ–‡æœ¬å¹¶ä¿ç•™æ¢è¡Œ
              htmlContent = reportContent.replace(/\n/g, "<br>");
            }

            html += `
              <div class="content-section">
                <div class="content-text markdown-body">${htmlContent}</div>
              </div>
            `;
            console.log("âœ… [formatReportResult] æŠ¥å‘Šå†…å®¹å·²æ·»åŠ åˆ°HTML");
          } else {
            html += `
              <div class="warning-card">
                <h4>âš ï¸ æç¤º</h4>
                <p>æŠ¥å‘Šå†…å®¹ä¸ºç©ºï¼Œå¯èƒ½æ˜¯ç”Ÿæˆè¿‡ç¨‹ä¸­å‡ºç°äº†é—®é¢˜ã€‚</p>
              </div>
            `;
          }

          container.innerHTML = html;
        } catch (error) {
          console.error("æ ¼å¼åŒ–æŠ¥å‘Šå¤±è´¥:", error);
          container.innerHTML = `<p style="color: #ef4444;">æ ¼å¼åŒ–æ˜¾ç¤ºå¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</p>`;
        }
      }

      // ========== ç¾åŒ–å›¾åƒåˆ†æç»“æœ ==========
      function formatAnalysisResult(container, data) {
        try {
          const analysisResult = data.analysis_result || "";
          const extractedData = data.extracted_data || {};
          const typhoonId = data.typhoon_id || "æœªçŸ¥";
          const typhoonName =
            data.typhoon_name || extractedData.typhoon_name || "æœªå‘½å";
          const modelUsed = data.model_used || "æœªçŸ¥";
          const createdAt = data.created_at || new Date().toISOString();

          // æ ¼å¼åŒ–æ—¶é—´
          const formattedTime = new Date(createdAt).toLocaleString("zh-CN", {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
          });

          let html = `
            <h3>ğŸ–¼ï¸ å«æ˜Ÿå›¾åƒåˆ†æç»“æœ</h3>
            <div class="meta-info">
              <div class="meta-item">
                <span class="meta-label">ğŸ†” å°é£ç¼–å·:</span>
                <span class="meta-value">${typhoonId}</span>
              </div>
              <div class="meta-item">
                <span class="meta-label">ğŸŒ€ å°é£åç§°:</span>
                <span class="meta-value">${typhoonName}</span>
              </div>
              <div class="meta-item">
                <span class="meta-label">ğŸ¤– AIæ¨¡å‹:</span>
                <span class="meta-value">${modelUsed}</span>
              </div>
              <div class="meta-item">
                <span class="meta-label">â° åˆ†ææ—¶é—´:</span>
                <span class="meta-value">${formattedTime}</span>
              </div>
            </div>
          `;

          // æ˜¾ç¤ºåˆ†æç»“æœ
          if (analysisResult) {
            console.log("ğŸ–¼ï¸ [formatAnalysisResult] å¼€å§‹å¤„ç†åˆ†æå†…å®¹");
            console.log("åŸå§‹å†…å®¹é•¿åº¦:", analysisResult.length);
            console.log("åŸå§‹å†…å®¹å‰100å­—ç¬¦:", analysisResult.substring(0, 100));

            // ä½¿ç”¨marked.jså°†Markdownè½¬æ¢ä¸ºHTML
            let htmlContent = analysisResult;
            const markedAvailable =
              typeof marked !== "undefined" && marked.parse;
            console.log("marked.js å¯ç”¨:", markedAvailable);

            if (markedAvailable) {
              try {
                console.log("ğŸ”„ å¼€å§‹Markdownè§£æ...");
                htmlContent = marked.parse(analysisResult);
                console.log("âœ… Markdownè§£ææˆåŠŸ");
                console.log("è§£æåHTMLé•¿åº¦:", htmlContent.length);
                console.log(
                  "è§£æåHTMLå‰200å­—ç¬¦:",
                  htmlContent.substring(0, 200)
                );
              } catch (e) {
                console.error("âŒ Markdownè§£æå¤±è´¥:", e);
                console.warn("é™çº§ä½¿ç”¨åŸå§‹æ–‡æœ¬");
                // å¦‚æœMarkdownè§£æå¤±è´¥ï¼Œä½¿ç”¨åŸå§‹æ–‡æœ¬å¹¶ä¿ç•™æ¢è¡Œ
                htmlContent = analysisResult.replace(/\n/g, "<br>");
              }
            } else {
              console.warn("âš ï¸ marked.jsæœªåŠ è½½ï¼Œä½¿ç”¨åŸå§‹æ–‡æœ¬");
              // å¦‚æœmarked.jsæœªåŠ è½½ï¼Œä½¿ç”¨åŸå§‹æ–‡æœ¬å¹¶ä¿ç•™æ¢è¡Œ
              htmlContent = analysisResult.replace(/\n/g, "<br>");
            }

            html += `
              <div class="content-section">
                <h4 style="color: #374151; margin-bottom: 10px;">ğŸ“ åˆ†æå†…å®¹</h4>
                <div class="content-text markdown-body">${htmlContent}</div>
              </div>
            `;
            console.log("âœ… [formatAnalysisResult] åˆ†æå†…å®¹å·²æ·»åŠ åˆ°HTML");
          }

          // æ˜¾ç¤ºæå–çš„æ•°æ®
          if (extractedData && Object.keys(extractedData).length > 0) {
            html += `<div class="content-section">
              <h4 style="color: #374151; margin-bottom: 10px;">ğŸ“Š æå–çš„æ•°æ®</h4>
              <div class="data-grid">`;

            for (const [key, value] of Object.entries(extractedData)) {
              if (
                value !== null &&
                value !== undefined &&
                key !== "forecast_points"
              ) {
                const label = translateFieldName(key);
                html += `
                  <div class="data-item">
                    <div class="data-item-label">${label}</div>
                    <div class="data-item-value">${value}</div>
                  </div>
                `;
              }
            }

            html += `</div></div>`;

            // æ˜¾ç¤ºé¢„æµ‹ç‚¹
            if (
              extractedData.forecast_points &&
              Array.isArray(extractedData.forecast_points) &&
              extractedData.forecast_points.length > 0
            ) {
              html += `
                <div class="info-card">
                  <h4>ğŸ“ é¢„æµ‹è·¯å¾„ç‚¹ (${extractedData.forecast_points.length}ä¸ª)</h4>
                  <p>ç³»ç»Ÿå·²æå– ${extractedData.forecast_points.length} ä¸ªé¢„æµ‹è·¯å¾„ç‚¹ã€‚</p>
                </div>
              `;
            }
          }

          if (
            !analysisResult &&
            (!extractedData || Object.keys(extractedData).length === 0)
          ) {
            html += `
              <div class="warning-card">
                <h4>âš ï¸ æç¤º</h4>
                <p>æœªèƒ½ä»å›¾åƒä¸­æå–æœ‰æ•ˆä¿¡æ¯ï¼Œå¯èƒ½æ˜¯å›¾åƒè´¨é‡é—®é¢˜æˆ–AIè¯†åˆ«å¤±è´¥ã€‚</p>
              </div>
            `;
          }

          container.innerHTML = html;
        } catch (error) {
          console.error("æ ¼å¼åŒ–å›¾åƒåˆ†æç»“æœå¤±è´¥:", error);
          container.innerHTML = `<p style="color: #ef4444;">æ ¼å¼åŒ–æ˜¾ç¤ºå¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</p>`;
        }
      }

      // ========== å­—æ®µåç¿»è¯‘è¾…åŠ©å‡½æ•°ï¼ˆç”¨äºformatAnalysisResultï¼‰ ==========
      function translateFieldName(fieldName) {
        const translations = {
          typhoon_id: "å°é£ç¼–å·",
          typhoon_name: "å°é£åç§°",
          latitude: "çº¬åº¦",
          longitude: "ç»åº¦",
          pressure: "ä¸­å¿ƒæ°”å‹",
          wind_speed: "æœ€å¤§é£é€Ÿ",
          forecast_time: "é¢„æŠ¥æ—¶é—´",
          intensity: "å¼ºåº¦ç­‰çº§",
          center_pressure: "ä¸­å¿ƒæ°”å‹",
          max_wind_speed: "æœ€å¤§é£é€Ÿ",
          moving_speed: "ç§»åŠ¨é€Ÿåº¦",
          moving_direction: "ç§»åŠ¨æ–¹å‘",
        };
        return translations[fieldName] || fieldName;
      }

      // ========== æ—¶é—´æˆ³æ ¼å¼åŒ–å‡½æ•° ==========
      function formatTimestamp(timestamp) {
        try {
          const date = new Date(timestamp);
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, "0");
          const day = String(date.getDate()).padStart(2, "0");
          const hour = String(date.getHours()).padStart(2, "0");
          const minute = String(date.getMinutes()).padStart(2, "0");
          return `${year}å¹´${month}æœˆ${day}æ—¥${hour}æ—¶${minute}åˆ†`;
        } catch (error) {
          return timestamp;
        }
      }
    </script>
  </body>
</html>
