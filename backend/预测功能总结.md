# 台风预测功能总结文档

## 一、项目整体结构与模块划分

### 1.1 目录结构

```
backend/
├── app/
│   ├── api/
│   │   └── prediction.py          # API路由：预测接口定义
│   ├── services/
│   │   └── prediction/
│   │       ├── __init__.py        # 模块初始化
│   │       ├── predictor.py       # 核心预测器（TyphoonPredictor）
│   │       ├── predictor_advanced.py  # 高级预测器（任意起点、滚动预测）
│   │       ├── predictor_fallback.py  # 降级预测器（线性外推）
│   │       ├── data/
│   │       │   ├── __init__.py
│   │       │   ├── csv_loader.py      # CSV数据加载
│   │       │   ├── preprocessor.py    # 数据预处理与特征工程
│   │       │   └── dataset.py         # PyTorch数据集
│   │       ├── models/
│   │       │   ├── __init__.py
│   │       │   ├── lstm_model.py      # Transformer+LSTM模型
│   │       │   └── loss_functions.py  # 损失函数
│   │       └── utils/
│   │           ├── __init__.py
│   │           ├── validators.py      # 输入验证
│   │           └── typhoon_id_utils.py # 台风编号工具
│   └── models/
│       └── typhoon.py             # 数据库模型
├── training/
│   ├── train_model_v3.py          # 模型训练脚本
│   ├── evaluate_model.py          # 模型评估
│   └── test_prediction.py         # 预测测试
└── data/csv/
    └── typhoon_paths_1966_2026.csv  # 训练数据源
```

### 1.2 核心模块职责

| 模块 | 职责 |
|------|------|
| `predictor.py` | 核心预测逻辑，模型加载与推理 |
| `predictor_advanced.py` | 扩展功能：任意起点预测、滚动预测 |
| `predictor_fallback.py` | 降级策略：当模型不可用时使用线性外推 |
| `preprocessor.py` | 特征工程、数据归一化、序列构建 |
| `csv_loader.py` | 从CSV加载台风路径数据 |
| `lstm_model.py` | Transformer+LSTM神经网络模型 |

---

## 二、预测功能使用方法

### 2.1 接口说明

#### 2.1.1 标准预测接口

**Endpoint**: `POST /api/predictions/{typhoon_id}`

**功能**: 基于台风历史路径进行未来路径预测

**参数**:
- `typhoon_id` (path): 台风编号（如"202001"）
- `forecast_hours` (query): 预报时效，默认48小时

**响应**:
```json
[
  {
    "forecast_time": "2020-05-17T02:00:00",
    "predicted_latitude": 19.39,
    "predicted_longitude": 119.78,
    "predicted_pressure": 1000.0,
    "predicted_wind_speed": 20.0,
    "confidence": 0.90,
    "prediction_model": "TransformerLSTM"
  }
]
```

#### 2.1.2 任意起点预测接口

**Endpoint**: `POST /api/predictions/arbitrary-start`

**功能**: 从指定时间、位置开始预测（假设情景分析）

**请求体**:
```json
{
  "typhoon_id": "202001",
  "start_time": "2020-05-16T17:00:00",
  "start_latitude": 18.60,
  "start_longitude": 120.10,
  "start_pressure": 1000,
  "start_wind_speed": 20,
  "forecast_hours": 48
}
```

#### 2.1.3 滚动预测接口

**Endpoint**: `POST /api/predictions/rolling`

**功能**: 持续更新预测，模拟实时预测场景

**参数**:
- `initial_forecast_hours`: 初始预报时效（默认48小时）
- `update_interval_hours`: 更新间隔（默认6小时）
- `max_iterations`: 最大滚动次数（默认5次）

### 2.2 调用示例

```python
import requests

# 标准预测
response = requests.post(
    "http://localhost:8000/api/predictions/202001",
    params={"forecast_hours": 48}
)
predictions = response.json()

# 任意起点预测
response = requests.post(
    "http://localhost:8000/api/predictions/arbitrary-start",
    json={
        "typhoon_id": "202001",
        "start_time": "2020-05-16T17:00:00",
        "start_latitude": 18.60,
        "start_longitude": 120.10,
        "forecast_hours": 48
    }
)
predictions = response.json()
```

### 2.3 参数要求

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| typhoon_id | string | 是 | 台风编号，支持4位或6位格式 |
| forecast_hours | int | 否 | 预报时效，默认48，可选12/24/48/72/120 |
| start_time | datetime | 任意起点 | ISO格式时间 |
| start_latitude | float | 任意起点 | 起点纬度，范围[-90, 90] |
| start_longitude | float | 任意起点 | 起点经度，范围[-180, 180] |

---

## 三、核心算法原理与数学模型

### 3.1 模型架构：Transformer + LSTM

```
输入序列 [batch, seq_len, 14]
    ↓
Transformer编码器 (2层，8头注意力)
    ↓
LSTM层 (2层，隐藏维度256)
    ↓
输出头 (均值、标准差、置信度)
    ↓
预测结果 [batch, pred_steps, 4]
```

### 3.2 特征工程（14维）

| 索引 | 特征 | 说明 | 归一化方式 |
|------|------|------|------------|
| 0 | latitude | 纬度 | Min-Max [-90, 90] → [0, 1] |
| 1 | longitude | 经度 | Min-Max [-180, 180] → [0, 1] |
| 2 | center_pressure | 中心气压 | Z-Score标准化 |
| 3 | max_wind_speed | 最大风速 | Z-Score标准化 |
| 4 | moving_speed | 移动速度 | Z-Score标准化 |
| 5 | moving_direction | 移动方向 | Min-Max [0, 360] → [0, 1] |
| 6 | hour | 小时 | /23 |
| 7 | month | 月份 | /12 |
| 8 | velocity_lat | 纬度速度 | Z-Score标准化 |
| 9 | velocity_lon | 经度速度 | Z-Score标准化 |
| 10 | acceleration_lat | 纬度加速度 | Z-Score标准化 |
| 11 | acceleration_lon | 经度加速度 | Z-Score标准化 |
| 12 | month_sin | 月份正弦编码 | - |
| 13 | month_cos | 月份余弦编码 | - |

### 3.3 损失函数

**组合损失**:
```
L_total = λ1 * L_position + λ2 * L_intensity + λ3 * L_temporal + λ4 * L_uncertainty
```

- **位置损失** (`L_position`): MSE损失，预测经纬度
- **强度损失** (`L_intensity`): MSE损失，预测气压和风速
- **时序一致性损失** (`L_temporal`): 惩罚路径不连贯
- **不确定性损失** (`L_uncertainty`): 负对数似然，估计预测不确定性

### 3.4 相对位置变化训练（V3模型）

**创新点**: 模型预测相对位置变化而非绝对位置

```python
# 目标值计算
target_lat_change = (future_lat - current_lat) / lat_range
target_lon_change = (future_lon - current_lon) / lon_range

# 预测时转换回绝对位置
predicted_lat = current_lat + predicted_change * lat_range
```

**优势**:
- 起点自适应：预测结果自动适配不同起点
- 数值稳定性：变化量通常比绝对值更小
- 泛化能力：对未见过的位置区域更鲁棒

### 3.5 置信度计算

```python
# 基于预测标准差
confidence_from_std = 1.0 - clip(std / 5.0, 0, 1)

# 模型输出置信度
model_confidence = model_output.confidence

# 组合置信度（加权平均）
confidence = w1 * confidence_from_std + w2 * model_confidence

# 时间衰减
confidence *= exp(-0.05 * time_step)

# 裁剪到合理范围
confidence = clip(confidence, 0.50, 0.95)
```

---

## 四、关键技术细节

### 4.1 数据流程

```
CSV数据
  ↓
CSVDataLoader (解析CSV，生成TyphoonPathData)
  ↓
DataPreprocessor
  ├── 数据清洗（去重、排序、缺失值处理）
  ├── 特征工程（计算速度、加速度、方向）
  ├── 归一化（Min-Max / Z-Score）
  └── 序列构建（取最近12个时间点）
  ↓
模型输入 [1, 12, 14]
  ↓
TransformerLSTMModel
  ↓
模型输出 [1, 8, 4] (位置+强度)
  ↓
反归一化 → 构建预测点 → 返回结果
```

### 4.2 核心代码逻辑

#### 4.2.1 预测流程（predictor.py）

```python
async def predict(historical_paths, forecast_hours):
    # 1. 验证输入
    if not self._validate_input(historical_paths):
        return await self._fallback_prediction(...)
    
    # 2. 数据预处理
    input_tensor = self._preprocess(historical_paths)
    
    # 3. 模型推理
    with torch.no_grad():
        predictions, std, confidence = self.model(input_tensor)
    
    # 4. 反归一化
    denorm_predictions = self.preprocessor.denormalize(predictions)
    
    # 5. 平滑处理（可选）
    denorm_predictions = self._smooth_predictions(denorm_predictions)
    
    # 6. 构建预测点
    predicted_points = self._build_prediction_points(...)
    
    return PredictionResult(...)
```

#### 4.2.2 任意起点预测（predictor_advanced.py）

```python
async def predict_from_arbitrary_start(historical_paths, start_point):
    # 1. 准备扩展的历史数据
    extended_paths = self._prepare_extended_paths(
        historical_paths, start_point
    )
    
    # 2. 使用标准预测方法
    result = await self.predict(extended_paths, ...)
    
    # 3. 调整预测结果时间
    result.base_time = start_point.timestamp
    for i, point in enumerate(result.predictions):
        point.forecast_time = start_point.timestamp + timedelta(hours=3*(i+1))
    
    return result
```

### 4.3 关键函数说明

| 函数 | 文件 | 功能 |
|------|------|------|
| `predict()` | predictor.py | 核心预测函数，执行完整预测流程 |
| `_preprocess()` | predictor.py | 数据预处理，将路径数据转换为模型输入张量 |
| `_smooth_predictions()` | predictor.py | 预测结果平滑，减少路径跳动 |
| `_build_prediction_points()` | predictor.py | 构建预测点列表，设置时间和置信度 |
| `extract_features()` | preprocessor.py | 特征工程，从路径提取14维特征 |
| `normalize()` | preprocessor.py | 特征归一化/标准化 |
| `predict_from_arbitrary_start()` | predictor_advanced.py | 任意起点预测 |
| `rolling_prediction()` | predictor_advanced.py | 滚动预测，持续更新 |

### 4.4 模型配置

```python
# 模型参数
input_size = 14          # 输入特征维度
hidden_size = 256        # LSTM隐藏层维度
num_lstm_layers = 2      # LSTM层数
num_transformer_layers = 2  # Transformer层数
num_heads = 8            # 注意力头数
output_size = 4          # 输出维度（lat, lon, pressure, wind）

# 预测参数
sequence_length = 12     # 输入序列长度（72小时）
prediction_steps = 8     # 预测步数（48小时，每6小时一步）
time_interval = 6        # 时间间隔（小时）
```

### 4.5 降级策略

当模型不可用时，自动切换到线性外推降级策略：

```python
async def _fallback_prediction(historical_paths, forecast_hours):
    # 1. 计算历史平均移动速度和方向
    avg_velocity = calculate_average_velocity(historical_paths)
    
    # 2. 线性外推
    for i in range(num_points):
        predicted_lat = last_lat + avg_velocity_lat * time_factor
        predicted_lon = last_lon + avg_velocity_lon * time_factor
    
    return PredictionResult(..., is_fallback=True)
```

---

## 五、性能指标

### 5.1 验证指标（V3模型）

| 指标 | 值 | 说明 |
|------|-----|------|
| 纬度误差 | 0.52° | 验证集平均绝对误差 |
| 经度误差 | 0.76° | 验证集平均绝对误差 |
| 气压误差 | 10.35 hPa | 验证集平均绝对误差 |
| 风速误差 | 1.94 m/s | 验证集平均绝对误差 |
| 置信度 | 0.999 | 模型置信度 |

### 5.2 预测示例

台风202001（VONGFONG）48小时预测：

| 时间 | 预测纬度 | 预测经度 | 移动距离 |
|------|----------|----------|----------|
| 20:00 | 18.86° | 119.85° | - (起点) |
| 23:00 | 19.12° | 119.83° | 0.26° |
| 02:00 | 19.39° | 119.78° | 0.27° |
| 05:00 | 19.76° | 119.64° | 0.40° |
| 08:00 | 20.23° | 119.77° | 0.49° |
| 11:00 | 20.60° | 119.35° | 0.55° |
| 14:00 | 20.26° | 119.86° | 0.61° |
| 17:00 | 20.61° | 119.57° | 0.45° |

平均移动距离：0.43°/3小时，符合台风正常移动速度。

---

## 六、维护说明

### 6.1 模型更新

1. 训练新模型：`python training/train_model_v3.py`
2. 替换模型文件：`training/models/best_model.pth`
3. 重启后端服务

### 6.2 日志级别

- **INFO**: 关键操作（模型加载、预测完成）
- **WARNING**: 异常情况（降级策略、数据不足）
- **ERROR**: 错误信息（模型推理失败）

### 6.3 常见问题

1. **预测点移动过小**: 检查平滑参数 `alpha`，当前设置为0.0（完全禁用平滑）
2. **模型加载失败**: 检查模型文件路径和CUDA可用性
3. **历史数据不足**: 确保输入至少3个时间点，时间跨度至少12小时
